
<!DOCTYPE html>
<html class="no-js" lang="en" class="js flexbox canvas canvastext webgl no-touch geolocation postmessage no-websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients no-cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths">
<head id="ContentPlaceHolderDefault_Head1">
    <meta http-equiv="X-UA-Compatible" content="IE=9,chrome=1" />
    <meta charset="utf-8" />
    <title>Windows Azure Training Kit - Building a Social Game with Windows Azure</title>
    <link rel="Stylesheet" type="text/css" media="all" href="styles/master.css" />
</head>
<body id="top" class="page-">
    <div id="page">
        <div id="wrapper" class="landingPage getStartedPage">            
            <div class="header">								
				<img alt="Windows Azure" src="images/azure-logo.png" />
				<span class="mainHomepageSubTitle">Training Kit - June 2012 Update</span>								
			</div>			
			<div class="nav-menu-header">
				<nav>
					<ul>
						<li class="MenuLink-Selected">
							<a href="#">Content</a>
						</li>
												<li class="MenuLink">
							<a href="Source">Setup</a>
						</li>
											</ul>
				
										
						<span id="github-btn" class="github-btn">
						  <a id="gh-btn" title="Fork this repo in GitHub" href="https://github.com/WindowsAzure-TrainingKit/HOL-BuildingSocialGame" target="_blank" class="gh-btn">
							<span class="gh-ico"></span>
							<span id="gh-text" class="gh-text">Fork</span>
						  </a>								  
						</span>								
						<span id="github-btn" class="github-btn github-watchers">
						  <a id="gh-btn" title="Watch this repo in GitHub" href="https://github.com/WindowsAzure-TrainingKit/HOL-BuildingSocialGame" target="_blank" class="gh-btn">
							<span class="gh-ico"></span>
							<span id="gh-text" class="gh-text">Watch</span>
						  </a>								  
						</span>
						
									
				</nav>
			</div>	        
		</span>
			<div id="content" class="textpage">
            <section id="content-container">
				<div id="content" class="textpage">
			    <a name="top"></a>
				
				

		<div class="content">
			<?xml version="1.0" encoding="iso-8859-1"?><span><p><a name="HOLTop"></a></p>

<h1 id="Building_a_Social_Game_with_Windows_Azure">Building a Social Game with Windows Azure</h1>

<hr />

<p><a name="Overview"></a></p>

<h2 id="Overview">Overview</h2>

<p>Building a game has multiple challenges, more if we are building social games that require multiplayers, contacting your friends, leaderboards and multiple ways to authenticate a user. In this lab, you will see how to take advantage of the <strong>Windows Azure</strong> services benefits when building a Social Game. <strong>Windows Azure</strong> offers <strong>Access Control</strong> service to authenticate your users using multiple Social Providers, such as <strong>Microsoft Account</strong> or <strong>Facebook</strong>. You can take advantage of <strong>Azure Table Storage</strong> to create a Leaderboard or to use it as a game storage, where clients access to update the game status in their browsers. Additionally, you will see how to use <strong>Node.JS</strong> to emit and broadcast the players game moves to other clients in real time.</p>

<p><a name="Objectives"></a></p>

<h3 id="Objectives">Objectives</h3>

<p>In this hands-on lab, you will learn how to:</p>

<ul>
<li>Add ACS Support and Invite friends</li>
<li>Enable Multi-Player using Storage Polling</li>
<li>Enable Multi-Player using Node.Js</li>
<li>Create a Leaderboard using Azure Table Storage</li>
</ul>

<p><a name="Prerequisites"></a> </p>

<h3 id="Prerequisites">Prerequisites</h3>

<p>The following is required to complete this hands-on lab:</p>

<ul>
<li><a href="http://go.microsoft.com/fwlink/?linkid=186916">Microsoft .NET Framework 4.0</a></li>
<li><a href="http://msdn.microsoft.com/vstudio/products/">Microsoft Visual Studio 2010</a></li>
<li><a href="http://www.microsoft.com/windowsazure/sdk/">Windows Azure SDK and Windows Azure Tools for Microsoft Visual Studio 1.7</a></li>
<li><a href="http://www.asp.net/mvc/mvc4">ASP.NET and ASP.NET MVC 4</a></li>
<li><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=c148b2df-c7af-46bb-9162-2c9422208504">Microsoft(r) Windows Identity Foundation SDK 4.0</a></li>
<li><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=eb9c345f-e830-40b8-a5fe-ae7a864c4d76">Microsoft(r) Windows Identity Foundation Runtime</a></li>
</ul>
<blockquote>
<p><strong>Note:</strong> This hands-on lab has been designed to use Windows 7 Operating System and the latest release of the Windows Azure Tools for Visual Studio 2010 (version 1.7).</p>
</blockquote>
<p><a name="Setup"></a> </p>

<h3 id="Setup">Setup</h3>

<p>In order to execute the exercises in this hands-on lab you need to set up your environment.</p>

<ol>
<li><p>Open a Windows Explorer window and browse to the <strong>Source</strong> folder.</p></li>
<li><p>Execute the <strong>Setup.cmd</strong> file with Administrator privileges to launch the setup process that will configure your environment and install the Visual Studio code snippets for this lab.</p></li>
<li><p>If the User Account Control dialog is shown, confirm the action to proceed.</p></li>
</ol>
<blockquote>
<p><strong>Note:</strong> Make sure you have checked all the dependencies for this lab before running the setup.</p>

<p><strong>Note:</strong> When you first start Visual Studio, you must select one of the predefined settings collections. Every predefined collection is designed to match a particular development style and determines window layouts, editor behavior, IntelliSense code snippets, and dialog box options. The procedures in this lab describe the actions necessary to accomplish a given task in Visual Studio when using the <strong>General Development Settings</strong> collection. If you choose a different settings collection for your development environment, there may be differences in these procedures that you need to take into account.</p>
</blockquote>
<p><a name="CodeSnippets"></a> </p>

<h3 id="Using_the_Code_Snippets">Using the Code Snippets</h3>

<p>Throughout the lab document, you will be instructed to insert code blocks. For your convenience, most of that code is provided as Visual Studio Code Snippets, which you can use from within Visual Studio 2010 to avoid having to add it manually.</p>

<hr />

<p><a name="Exercises"></a> </p>

<h2 id="Exercises">Exercises</h2>

<p>This hands-on lab includes the following exercises:</p>

<ol>
<li><p><a href="#Exercise1">Adding Social Providers and Inviting Friends</a></p></li>
<li><p><a href="#Exercise2">Enable Multiplayer with Storage Polling</a></p></li>
<li><p><a href="#Exercise3">Enable Multiplayer with Node.js</a></p></li>
<li><p><a href="#Exercise4">Creating a Leaderboard</a></p></li>
</ol>

<p>Estimated time to complete this lab: <strong>90 minutes</strong>.</p>
<blockquote>
<p><strong>Note:</strong> Each exercise is accompanied by a starting solution located in the Begin folder of the exercise that allows you to follow each exercise independently of the others. Please be aware that the code snippets that are added during an exercise are missing from these starting solutions and that they will not necessarily work until you complete the exercise. Inside the source code for an exercise, you will also find an End folder containing a Visual Studio solution with the code that results from completing the steps in the corresponding exercise. You can use these solutions as guidance if you need additional help as you work through this hands-on lab.</p>
</blockquote>
<p><a name="GettingStarted"></a> </p>

<h3 id="Understanding_the_Tic-Tac-Toe_Solo_Game_Scenario">Understanding the Tic-Tac-Toe Solo Game Scenario</h3>

<p>In this exercise, you will explore the single player Tic-Tac-Toe solution's structure and the logic used for the game flow. Throughout this lab, based on this example, you will update the Tic-Tac-Toe solution to support social gaming features for inviting friends, using ACS and Social Providers to authenticate the players and enabling multiplayer mode. Finally, you will generate a leaderboard by using Azure Table Storage.</p>

<p><a name="GtsTask1"></a> </p>

<h4 id="Task_1_-_Exploring_Tic-Tac-Toe_Solution">Task 1 - Exploring Tic-Tac-Toe Solution</h4>

<p>In this task, you will explore the Tic-Tac-Toe sample to identify the core libraries that uses and how do they work.</p>

<ol>
<li><p>Start <strong>Microsoft Visual Studio 2010</strong> as administrator.</p></li>
<li><p>Open the <strong>Begin.sln</strong> solution located at <strong>Source\Ex0-SoloGame\Begin</strong>.</p></li>
<li><p>In the <strong>Solution Explorer</strong>, expand <strong>Scripts\Game\TicTacToe</strong> folder within <strong>TicTacToe.Web</strong> node to display the core libraries used in the sample.</p>

<p><img src="./images/game-core-libraries.png?raw=true" alt="Game core libraries" title="Game core libraries" />
</p>

<p><em>Game core libraries</em></p>

<ol>
<li><strong>Controllers.js</strong>: This file handles the interaction between the view and the game logic. It includes methods like <em>start</em>, <em>onMove</em>, <em>updateGameStatus</em>, <em>etc</em>.</li>
<li><p><strong>ViewModel.js</strong>: This file defines the view model structure that will be used to bind the view with the controller.</p>
<blockquote>
<p><strong>Note:</strong> We are using the <strong>Knockout</strong> JavaScript library for binding our sample's UI with the controller logic. Knockout is a library used to simplify dynamic JavaScript UIs by applying the Model-View-View Model (MVVM) pattern. You can find more information about Knockout library in this link: <a href="http://knockoutjs.com/"><a href="http://knockoutjs.com/">http://knockoutjs.com/</a></a>.</p>
</blockquote></li>
<li><p><strong>Board.js</strong>: This file contains the necessary logic to render the Tic-Tac-Toe board into an HTML5 canvas.</p></li>
<li><p><strong>Game.js</strong>: This class file contains the game logic, which includes player's turns, movements, existence of a winner, etc.</p></li>
</ol></li>
<li><p>Open the <strong>Index.cshtml</strong> view located in the <strong>Views\TicTacToe</strong> folder. This view renders the Tic-Tac-Toe game and interacts with the controller. Notice that this file only contains the canvas element and the reference to the JavaScript libraries.</p></li>
</ol>

<p><a name="GtsVerification"></a> </p>

<h4 id="Verification_-_Running_the_Solution">Verification - Running the Solution</h4>

<p>In this task, you will run the solution and play a single-player Tic-Tac-Toe game.</p>
<blockquote>
<p><strong>Note:</strong> To designate the start page, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web</strong> project and select <strong>Properties</strong>. In the <strong>Properties</strong> window, select the <strong>Web</strong> tab and in the <strong>Start Action</strong>, select <strong>Specific Page</strong>. Set the value of this field empty.</p>
</blockquote>
<ol>
<li><p>In <strong>Visual Studio</strong>, press <strong>F5</strong> to build and run the solution.</p></li>
<li><p>In the Social Gaming Sample Home page, click <strong>Tic Tac Toe</strong> in the menu to start a new single-player game.</p>

<p><img src="images/running-the-tic-tac-toe-sample.png?raw=true" alt="Running the Tic-Tac-Toe sample" />
</p>

<p><em>Running the Tic-Tac-Toe sample</em></p></li>
<li><p>Play a new Tic-Tac-Toe game to verify the game's flow. Then, close the browser and return to Visual Studio.</p>

<p><img src="images/playing-tic-tac-toe-single-player-mode.png?raw=true" alt="Playing Tic-Tac-Toe, single player mode" />
</p>

<p><em>Playing Tic-Tac-Toe, single player mode</em></p></li>
</ol>

<p><a name="Exercise1"></a> </p>

<h3 id="Exercise_1_Adding_Social_Providers_and_Inviting_Friends">Exercise 1: Adding Social Providers and Inviting Friends</h3>

<p>In this exercise, you will use Windows Azure Access Control Service (ACS) to enable authentication in the Tic-Tac-Toe game. The Access Control Service takes care of engaging every identity provider with its own authentication protocol, normalizing the authentication results in a protocol supported by the .NET framework tooling. In order to simplify the flow of this exercise, you will add the necessary configuration to access the existing public namespace '<em>local-watgames</em>', which is used in the <strong>Windows Azure Toolkit for Social Games</strong>. Next, you will create a view to send invitations to other users and see the list of friends you added.</p>
<blockquote>
<p><strong>Note:</strong> In this exercise you will add social gaming features, but the multiplayer mode will be added in the following exercises.</p>
</blockquote>
<p><a name="Ex1Task1"></a></p>

<h4 id="Task_1_-_Configuring_ACS">Task 1 - Configuring ACS</h4>

<ol>
<li><p>Open the <strong>Begin.sln</strong> solution located in the folder <strong>\Source\Ex1-ACSAndInvite\Begin</strong>. You can alternatively continue working with the solution from Exercise 0.</p></li>
<li><p>Right-click the <strong>TicTacToe.Web</strong> project and select <strong>Add Windows Azure Deployment Project</strong>. This will create a Windows Azure deployment project that will host the <strong>TicTacToe.Web</strong> in the Cloud.</p></li>
<li><p>Open the <strong>Web.config</strong> file from the <strong>TicTacToe.Web</strong> project. You will next add the necessary entries to configure ACS to use the public namespace '<em>local-watgames</em>'.</p>

<ol>
<li><p>At the top of the file, below the <strong>configuration</strong> root node, add the following code to include the Windows Identity Foundation configuration section.</p>

<!-- mark: 1-3    -->

<span class="codelanguage">XML</span><pre><code class="XML"><strong class="markLine">  <span style="color:#0000FF">&lt;</span><span style="color:#800000">configSections</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">section</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;microsoft.identityModel&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;Microsoft.IdentityModel.Configuration.MicrosoftIdentityModelSection, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span> <span style="color:#0000FF">/&gt;</span>  </strong>
<strong class="markLine">  <span style="color:#0000FF">&lt;/</span><span style="color:#800000">configSections</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>In the <strong>appSettings</strong> element, add the following new entries with <strong>key</strong> <em>AcsNamespace</em>, <em>ApiUrl</em>, and <em>BlobUrl</em>.</p>

<!-- mark: 1-3    -->

<span class="codelanguage">XML</span><pre><code class="XML"><strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">key</span>=<span style="color:#0000FF">&quot;AcsNamespace&quot;</span> <span style="color:#FF0000">value</span>=<span style="color:#0000FF">&quot;local-watgames.accesscontrol.windows.net&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">key</span>=<span style="color:#0000FF">&quot;ApiUrl&quot;</span> <span style="color:#FF0000">value</span>=<span style="color:#0000FF">&quot;http://127.0.0.1:81/&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">key</span>=<span style="color:#0000FF">&quot;BlobUrl&quot;</span> <span style="color:#FF0000">value</span>=<span style="color:#0000FF">&quot;http://127.0.0.1:10000/devstoreaccount1/&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
</code></pre></li>
<li><p>Locate the <strong>system.web</strong> closing node and add the following code above the closing tag.</p>

<!-- mark: 1-5    -->

<span class="codelanguage">XML</span><pre><code class="XML"><strong class="markLine">   <span style="color:#0000FF">&lt;</span><span style="color:#800000">httpRuntime</span> <span style="color:#FF0000">requestValidationType</span>=<span style="color:#0000FF">&quot;Microsoft.Samples.SocialGames.Web.Security.WSFederationRequestValidator&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;</span><span style="color:#800000">httpModules</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">     <span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;WSFederationAuthenticationModule&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;Microsoft.IdentityModel.Web.WSFederationAuthenticationModule, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">     <span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;SessionAuthenticationModule&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;Microsoft.IdentityModel.Web.SessionAuthenticationModule, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;/</span><span style="color:#800000">httpModules</span><span style="color:#0000FF">&gt;</span></strong>
 <span style="color:#0000FF">&lt;/</span><span style="color:#800000">system.web</span><span style="color:#0000FF">&gt;</span>
</code></pre></li>
<li><p>Inside the <strong>system.webServer</strong> node, replace the <strong>modules</strong> node with the following code:</p>

<!-- mark: 1-4    -->

<span class="codelanguage">XML</span><pre><code class="XML"><strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">modules</span> <span style="color:#FF0000">runAllManagedModulesForAllRequests</span>=<span style="color:#0000FF">&quot;true&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">  <span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;WSFederationAuthenticationModule&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;Microsoft.IdentityModel.Web.WSFederationAuthenticationModule, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span> <span style="color:#FF0000">preCondition</span>=<span style="color:#0000FF">&quot;managedHandler&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">  <span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;SessionAuthenticationModule&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;Microsoft.IdentityModel.Web.SessionAuthenticationModule, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span> <span style="color:#FF0000">preCondition</span>=<span style="color:#0000FF">&quot;managedHandler&quot;</span> <span style="color:#0000FF">/&gt;</span>      </strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">modules</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>At the end of the file, above the closing <strong>configuration</strong> node, add the <strong>Identity Model</strong> and the <strong>System.Service.Model</strong> sections copying the following code.</p>

<!-- mark: 1-20    -->

<span class="codelanguage">XML</span><pre><code class="XML"><strong class="markLine">  <span style="color:#0000FF">&lt;</span><span style="color:#800000">microsoft.identityModel</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">service</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">      <span style="color:#0000FF">&lt;</span><span style="color:#800000">audienceUris</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">value</span>=<span style="color:#0000FF">&quot;http://127.0.0.1:81/&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">      <span style="color:#0000FF">&lt;/</span><span style="color:#800000">audienceUris</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">      <span style="color:#0000FF">&lt;</span><span style="color:#800000">federatedAuthentication</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">wsFederation</span> <span style="color:#FF0000">passiveRedirectEnabled</span>=<span style="color:#0000FF">&quot;false&quot;</span> <span style="color:#FF0000">requireHttps</span>=<span style="color:#0000FF">&quot;false&quot;</span> <span style="color:#FF0000">issuer</span>=<span style="color:#0000FF">&quot;https://placeholder/&quot;</span> <span style="color:#FF0000">realm</span>=<span style="color:#0000FF">&quot;https://placeholder/&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">cookieHandler</span> <span style="color:#FF0000">requireSsl</span>=<span style="color:#0000FF">&quot;false&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">      <span style="color:#0000FF">&lt;/</span><span style="color:#800000">federatedAuthentication</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">      <span style="color:#0000FF">&lt;</span><span style="color:#800000">certificateValidation</span> <span style="color:#FF0000">certificateValidationMode</span>=<span style="color:#0000FF">&quot;None&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">      <span style="color:#0000FF">&lt;</span><span style="color:#800000">issuerNameRegistry</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;Microsoft.IdentityModel.Tokens.ConfigurationBasedIssuerNameRegistry, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">trustedIssuers</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">          <span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">thumbprint</span>=<span style="color:#0000FF">&quot;C89ECEF72C2A79809509E1E294DC68485E5042CF&quot;</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;https://local-watgames.accesscontrol.windows.net/&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">trustedIssuers</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">      <span style="color:#0000FF">&lt;/</span><span style="color:#800000">issuerNameRegistry</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">service</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">  <span style="color:#0000FF">&lt;/</span><span style="color:#800000">microsoft.identityModel</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">  <span style="color:#0000FF">&lt;</span><span style="color:#800000">system.serviceModel</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">serviceHostingEnvironment</span> <span style="color:#FF0000">aspNetCompatibilityEnabled</span>=<span style="color:#0000FF">&quot;true&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">  <span style="color:#0000FF">&lt;/</span><span style="color:#800000">system.serviceModel</span><span style="color:#0000FF">&gt;</span>  </strong>
</code></pre></li>
<li><p>Press <strong>CTRL+S</strong> to save the file and close it.</p></li>
</ol></li>
<li><p>Create a folder in the root of the <strong>TicTacToe.Web</strong> project and name it <em>Security</em>.</p></li>
<li><p>Right-click the <strong>Security</strong> folder and add an existing item. Browse to the <strong>Source\Assets\Security</strong> folder of the lab, select <strong>WSFederationRequestValidator.cs</strong>, and click <strong>Add</strong>.</p></li>
</ol>

<p><a name="Ex1Task2"></a></p>

<h4 id="Task_2_-_Adding_Social_Gaming_APIs">Task 2 - Adding Social Gaming APIs</h4>

<p>In this task, you will add the social gaming server APIs to enable a number of features on your game. This Server APIs (or Web APIs) are wrappers of a library named <strong>SocialGames.Core</strong>, which contains all the necessary logic to invite other users to your list of friends, as well as other features you will use throughout this lab. This library is based on the same library that is included in the <strong>Windows Azure Toolkit for Social Games</strong>.</p>
<blockquote>
<p><strong>Note:</strong> The APIs provided in the <strong>Assets</strong> folder of this lab are using the same strategy and architecture than the one used in the <strong>Windows Azure Toolkit for Social Games</strong> projects. For more information, go to <a href="https://github.com/WindowsAzure-Toolkits/wa-toolkit-games"><a href="https://github.com/WindowsAzure-Toolkits/wa-toolkit-games">https://github.com/WindowsAzure-Toolkits/wa-toolkit-games</a></a>.</p>
</blockquote>
<ol>
<li><p>In the <strong>TicTacToe.Web.Azure</strong> cloud project, open <strong>Properties</strong> for the <strong>TicTacToe.Web</strong> role and add a new setting with <strong>Name</strong> <em>DataConnectionString</em>, set <strong>Type</strong> to <em>Connection String</em> and for the <strong>Value</strong> choose <strong>Windows Azure Storage Emulator</strong>. Save and close the <strong>Properties</strong> page.</p>

<p><img src="images/adding-a-new-setting.png?raw=true" alt="Adding a new setting" />
</p>

<p><em>Adding a new setting</em></p></li>
<li><p>Copy the <strong>SocialGames.Core</strong> folder located in <strong>\Source\Assets</strong> in your solution folder.</p>

<p><img src="images/copying-socialgamescore-project-in-the-soluti.png?raw=true" alt="Copying SocialGames.Core project in the solution folder" />
</p>

<p><em>Copying SocialGames.Core project in the solution folder</em></p></li>
<li><p>You will add the Social Games core library to the Solution. Right-click the solution node, select <strong>Add</strong> and then <strong>Add Existing Project</strong>. Browse to the <strong>SocialGames.Core</strong> folder you have just copied and select the <strong>SocialGames.Core.csproj</strong> file in order to add the library to your solution.</p>
<blockquote>
<p><strong>Note:</strong> The <strong>SocialGames.Core</strong> is composed of four main folders: Common, Entities, Helpers and Repositories. The main logic resides in the Repositories classes.</p>
</blockquote>
<p><img src="images/socialgamescore-project.png?raw=true" alt="SocialGames.Core project" />
</p>

<p><em>SocialGames.Core project</em></p></li>
<li><p>In <strong>TicTacToe.Web</strong> project, add a reference to the recently added <strong>SocialGames.Core</strong> project.</p></li>
<li><p>Add three new folders at the root of the Web project and name them <em>Services</em>, <em>Extensions</em> and <em>WebApi</em> respectively.</p></li>
<li><p>Right-click the <strong>Services</strong> folder, select <strong>Add</strong> and then <strong>Add Exiting Item</strong>. Browse to the <strong>Source\Assets\Services</strong> folder of this lab and select all the files in the folder.</p></li>
<li><p>Right-click the <strong>Extensions</strong> folder, select <strong>Add</strong> and then <strong>Add Exiting Item</strong>. Browse to the <strong>Source\Assets\Extensions</strong> folder of this lab and select all the files in the folder.</p></li>
<li><p>Right-click the <strong>WebApi</strong> folder, select <strong>Add</strong> and then <strong>Add Exiting Item</strong>. Browse to the <strong>Source\Assets\WebApi</strong> folder of this lab and select all the files in the folder.</p></li>
<li><p>The Web APIs and the Extensions you added in the previous steps requires some dependencies that can be installed using the <strong>Package Manager Console</strong>. Click the <strong>TicTacToe.Web</strong> project and then select <strong>Tools | Library Package Manager | Package Manager Console</strong> from the Visual Studio Menu.</p></li>
<li><p>In the <strong>Package Manager Console</strong> window, type <strong>Install-Package Autofac.mvc4</strong> and wait for installation to complete. Once the process completes, close the <strong>Package Manager Console</strong> window.</p>

<p><img src="images/installing-autofac-package.png?raw=true" alt="Installing Autofac Package" />
</p>

<p><em>Installing Autofac Package</em></p></li>
<li><p>Add the following references to the <strong>TicTacToe.Web</strong> project: </p>

<ul>
<li><strong>Microsoft.IdentityModel</strong><br /></li>
<li><strong>Microsoft.WindowsAzure.ServiceRuntime</strong></li>
<li><strong>Microsoft.WindowsAzure.StorageClient</strong></li>
<li><strong>System.Json</strong></li>
<li><strong>System.Net.Http</strong></li>
<li><strong>System.Net.Http.Formatting</strong></li>
<li><strong>System.Net.Http.WebRequest</strong></li>
<li><strong>System.Web.Http</strong></li>
<li><strong>System.Web.Http.Common</strong></li>
<li><strong>System.Web.Http.WebHost</strong></li>
</ul></li>
<li><p>Open <strong>Global.asax</strong> file and replace the namespace declarations with the following:</p>

<p>(Code Snippet - <em>Building a Social Game - Ex1 Using Namespaces - CS</em>)</p>

<!-- mark: 1-19    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">using</span> System.Collections.Generic;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> System.Configuration;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> System.Web.Http;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> System.Web.Mvc;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> System.Web.Routing;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Autofac;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Autofac.Integration.Mvc;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.IdentityModel.Tokens;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.IdentityModel.Web;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.IdentityModel.Web.Configuration;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames.Common.Storage;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames.Entities;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames.Extensions;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames.Repositories;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames.Web.Services;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.WindowsAzure;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.WindowsAzure.ServiceRuntime;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> TicTacToe.Web.WebApi;</strong>
</code></pre></li>
<li><p>Now that you have the Web APIs in the project, we need to register the MVC routes to point to their address. Locate and replace the <strong>RegisterRoutes</strong> method with the following:</p>

<p>(Code Snippet - <em>Building a Social Game - Ex1 Registering Routes - CS</em>)</p>

<!-- mark: 1-14    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">static</span> <span style="color:#0000FF">void</span> RegisterRoutes(RouteCollection routes)</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    routes.IgnoreRoute(<span style="color:#8B0000">&quot;{resource}.axd/{*pathInfo}&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    routes.MapHttpRoute(</strong>
<strong class="markLine">        name: <span style="color:#8B0000">&quot;ActionApi&quot;</span>,</strong>
<strong class="markLine">        routeTemplate: <span style="color:#8B0000">&quot;api/{controller}/{action}/{id}&quot;</span>,</strong>
<strong class="markLine">        defaults: <span style="color:#0000FF">new</span> { id = RouteParameter.Optional });</strong>
<strong class="markLine"></strong>
<strong class="markLine">    routes.MapRoute(</strong>
<strong class="markLine">        <span style="color:#8B0000">&quot;Default&quot;</span>,</strong>
<strong class="markLine">        <span style="color:#8B0000">&quot;{controller}/{action}/{id}&quot;</span>,</strong>
<strong class="markLine">        <span style="color:#0000FF">new</span> { controller = <span style="color:#8B0000">&quot;Home&quot;</span>, action = <span style="color:#8B0000">&quot;Index&quot;</span>, id = UrlParameter.Optional });</strong>
<strong class="markLine">}</strong>
</code></pre></li>
<li><p>In the <strong>Application_Start</strong> method, you will setup the WCF Web Api configuration and register the core types in a Dependency Injection container using <strong>Autofac</strong>. To do this, replace the <strong>Application_Start</strong> method with the following code:</p>
<blockquote>
<p><strong>Note:</strong> For more information about <strong>Autofac</strong> go to <a href="http://code.google.com/p/autofac/"><a href="http://code.google.com/p/autofac/">http://code.google.com/p/autofac/</a></a>.</p>
</blockquote>
<p>(Code Snippet - <em>Building a Social Game - Ex1 Application Start - CS</em>)</p>

<!-- mark: 1-37    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> Application_Start()</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    CloudStorageAccount.SetConfigurationSettingPublisher((configName, configSetter) =&gt;</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">string</span> configuration = RoleEnvironment.IsAvailable ?</strong>
<strong class="markLine">            RoleEnvironment.GetConfigurationSettingValue(configName) :</strong>
<strong class="markLine">            ConfigurationManager.AppSettings[configName];</strong>
<strong class="markLine"></strong>
<strong class="markLine">        configSetter(configuration);</strong>
<strong class="markLine">    });</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Setup AutoFac</span></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> builder = <span style="color:#0000FF">new</span> ContainerBuilder();</strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.DependencySetup(builder);</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> container = builder.Build();</strong>
<strong class="markLine"></strong>
<strong class="markLine">    DependencyResolver.SetResolver(<span style="color:#0000FF">new</span> AutofacDependencyResolver(container));</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Setup WCF Web API Config</span></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> resolver = <span style="color:#0000FF">new</span> AutofacDependencyResolver(container);</strong>
<strong class="markLine">    GlobalConfiguration.Configuration.ServiceResolver.SetResolver(</strong>
<strong class="markLine">        t =&gt; resolver.GetService(t), t =&gt; resolver.GetServices(t));</strong>
<strong class="markLine"></strong>
<strong class="markLine">    AreaRegistration.RegisterAllAreas();</strong>
<strong class="markLine"></strong>
<strong class="markLine">    RegisterGlobalFilters(GlobalFilters.Filters);</strong>
<strong class="markLine">    RegisterRoutes(RouteTable.Routes);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    FederatedAuthentication.ServiceConfigurationCreated += <span style="color:#0000FF">this</span>.OnServiceConfigurationCreated;</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Call Initializers</span></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> initializers = DependencyResolver.Current.GetServices&lt;IStorageInitializer&gt;();</strong>
<strong class="markLine">    <span style="color:#0000FF">foreach</span> (<span style="color:#0000FF">var</span> initializer <span style="color:#0000FF">in</span> initializers)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        initializer.Initialize();</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">}</strong>
</code></pre></li>
<li><p>Add the following methods at the end of the file.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex1 DependencySetup - CS</em>)</p>

<!-- mark: 1-66    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">protected</span> <span style="color:#0000FF">void</span> DependencySetup(ContainerBuilder builder)</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    <span style="color:#008000">// Cloud Storage Account</span></strong>
<strong class="markLine">    builder.RegisterInstance&lt;CloudStorageAccount&gt;(CloudStorageAccount.FromConfigurationSetting(<span style="color:#8B0000">&quot;DataConnectionString&quot;</span>));</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Queues</span></strong>
<strong class="markLine">    builder.RegisterQueue&lt;GameActionStatisticsMessage&gt;(ConfigurationConstants.GameActionStatisticsQueue)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterQueue&lt;GameActionNotificationMessage&gt;(ConfigurationConstants.GameActionNotificationsQueue)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterQueue&lt;InviteMessage&gt;(ConfigurationConstants.InvitesQueue)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Blobs</span></strong>
<strong class="markLine">    builder.RegisterBlob&lt;UserProfile&gt;(ConfigurationConstants.UsersContainerName, <span style="color:#0000FF">true</span> <span style="color:#008000">/* jsonpSupport */</span>)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterBlob&lt;UserSession&gt;(ConfigurationConstants.UserSessionsContainerName, <span style="color:#0000FF">true</span> <span style="color:#008000">/* jsonpSupport */</span>)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterBlob&lt;Friends&gt;(ConfigurationConstants.FriendsContainerName, <span style="color:#0000FF">true</span> <span style="color:#008000">/* jsonpSupport */</span>)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterBlob&lt;NotificationStatus&gt;(ConfigurationConstants.NotificationsContainerName, <span style="color:#0000FF">true</span> <span style="color:#008000">/* jsonpSupport */</span>)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterBlob&lt;Game&gt;(ConfigurationConstants.GamesContainerName, <span style="color:#0000FF">true</span> <span style="color:#008000">/* jsonpSupport */</span>)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterBlob&lt;GameQueue&gt;(ConfigurationConstants.GamesQueuesContainerName, <span style="color:#0000FF">true</span> <span style="color:#008000">/* jsonpSupport */</span>)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterBlob&lt;UserProfile&gt;(ConfigurationConstants.GamesContainerName, <span style="color:#0000FF">true</span> <span style="color:#008000">/* jsonpSupport */</span>)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Tables</span></strong>
<strong class="markLine">    builder.RegisterTable&lt;UserStats&gt;(ConfigurationConstants.UserStatsTableName, <span style="color:#0000FF">true</span> <span style="color:#008000">/* jsonpSupport */</span>)</strong>
<strong class="markLine">        .AsImplementedInterfaces();</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Repositories</span></strong>
<strong class="markLine">    builder.RegisterType&lt;GameActionNotificationQueue&gt;().AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterType&lt;GameActionStatisticsQueue&gt;().AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterType&lt;GameRepository&gt;().AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterType&lt;IdentityProviderRepository&gt;().AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterType&lt;NotificationRepository&gt;().AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterType&lt;UserRepository&gt;().AsImplementedInterfaces();</strong>
<strong class="markLine">    builder.RegisterType&lt;StatisticsRepository&gt;().AsImplementedInterfaces();</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Controllers</span></strong>
<strong class="markLine">    builder.RegisterControllers(<span style="color:#0000FF">typeof</span>(MvcApplication).Assembly);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Services</span></strong>
<strong class="markLine">    builder.RegisterType&lt;AuthService&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine">    builder.RegisterType&lt;EventService&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine">    builder.RegisterType&lt;GameService&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine">    builder.RegisterType&lt;HttpContextUserProvider&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine">    builder.RegisterType&lt;UserService&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Api</span></strong>
<strong class="markLine">    builder.RegisterType&lt;AuthController&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine">    builder.RegisterType&lt;GameController&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine">    builder.RegisterType&lt;UserController&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine">    builder.RegisterType&lt;EventController&gt;().AsImplementedInterfaces().AsSelf();</strong>
<strong class="markLine">}</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">private</span> <span style="color:#0000FF">void</span> OnServiceConfigurationCreated(<span style="color:#0000FF">object</span> sender, ServiceConfigurationCreatedEventArgs e)</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> sessionTransforms = <span style="color:#0000FF">new</span> List&lt;CookieTransform&gt;(<span style="color:#0000FF">new</span> CookieTransform[] { <span style="color:#0000FF">new</span> DeflateCookieTransform() });</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> sessionHandler = <span style="color:#0000FF">new</span> SessionSecurityTokenHandler(sessionTransforms.AsReadOnly());</strong>
<strong class="markLine"></strong>
<strong class="markLine">    e.ServiceConfiguration.SecurityTokenHandlers.AddOrReplace(sessionHandler);</strong>
<strong class="markLine">}</strong>
</code></pre></li>
</ol>

<p><a name="Ex1Task3"></a></p>

<h4 id="Task_3_-_Creating_the_Login_View">Task 3 - Creating the Login View</h4>

<p>In this task, you will create the Login View that lists the Social Providers from Access Control.</p>

<ol>
<li><p>Open <strong>TicTacToeController</strong> and add the <strong>Authorize</strong> decorator to the <strong>Index</strong> method. If an unauthorized user tries to access the Tic Tac Toe view, the application will redirect the user to the <strong>LogOn</strong> view.</p>

<!-- mark: 1    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine">[Authorize]</strong>
<span style="color:#0000FF">public</span> ActionResult Index()
{
    <span style="color:#0000FF">return</span> View();
}
</code></pre></li>
<li><p>In the <strong>Controllers</strong> folder, add a new controller with the name <em>BaseController</em>.</p></li>
<li><p>The <strong>BaseController</strong> reads the values of the addresses for the Blob and API URLs and exposes to the View using the <strong>ViewBag</strong>. To do this, replace the class code with the following highlighted code:</p>

<p>(Code Snippet - <em>Building a Social Game - Ex1 BaseController - CS</em>)</p>

<!-- mark: 5-14    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">using</span> System.Web.Mvc;

<span style="color:#0000FF">namespace</span> TicTacToe.Web.Controllers
{
<strong class="markLine">    <span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> BaseController : Controller</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">protected</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">void</span> OnActionExecuting(ActionExecutingContext filterContext)</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            <span style="color:#0000FF">this</span>.ViewBag.BlobUrl = System.Configuration.ConfigurationManager.AppSettings[<span style="color:#8B0000">&quot;BlobUrl&quot;</span>];</strong>
<strong class="markLine">            <span style="color:#0000FF">this</span>.ViewBag.ApiUrl = System.Configuration.ConfigurationManager.AppSettings[<span style="color:#8B0000">&quot;ApiUrl&quot;</span>];</strong>
<strong class="markLine"></strong>
<strong class="markLine">            <span style="color:#0000FF">base</span>.OnActionExecuting(filterContext);</strong>
<strong class="markLine">        }</strong>
<strong class="markLine">    }</strong>
}
</code></pre></li>
<li><p>Create a new controller and name it <em>AccountController</em><strong>.</strong></p></li>
<li><p>Inherit <strong>AccountController</strong> from the <strong>BaseController</strong> you created in previous steps.</p>

<!-- mark: 1    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> AccountController : BaseController</strong>
{
...
}
</code></pre></li>
<li><p>Add the following using statements in the <strong>AccountController</strong>.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex1 AccountController Using- CS</em>)</p>

<!-- mark: 1-7    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">using</span> System.Threading;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.IdentityModel.Claims;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.IdentityModel.Protocols.WSFederation;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames.Repositories;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames.Web.Services;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames.Entities;</strong>
<strong class="markLine"><span style="color:#0000FF">using</span> Microsoft.Samples.SocialGames;</strong>
</code></pre></li>
<li><p>The <strong>AccountController</strong> is responsible of authenticating and reading Claims from the Identity Provider. The user Id is then saved (or updated if already exists) into a Table Storage to be used in the Game and in the Friends list. Replace the class content with the following:</p>

<p>(Code Snippet - <em>Building a Social Game - Ex1 Implementing AccountController - CS</em>)</p>

<!-- mark: 3-76    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> AccountController : BaseController
{
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">readonly</span> IUserRepository userRepository;</strong>
<strong class="markLine">    <span style="color:#0000FF">private</span> IUserProvider userProvider;</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">public</span> AccountController(IUserRepository userRepository, IUserProvider userProvider)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.userRepository = userRepository;</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.userProvider = userProvider;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">public</span> ActionResult LogOn(<span style="color:#0000FF">string</span> returnUrl)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">return</span> View();</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    [HttpPost]</strong>
<strong class="markLine">    <span style="color:#0000FF">public</span> ActionResult LogOn()</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (<span style="color:#0000FF">this</span>.Request.IsAuthenticated)</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            <span style="color:#008000">// Ensure user profile</span></strong>
<strong class="markLine">            <span style="color:#0000FF">var</span> userId = <span style="color:#0000FF">this</span>.GetClaimValue(ClaimTypes.NameIdentifier);</strong>
<strong class="markLine">            <span style="color:#0000FF">var</span> userProfile = <span style="color:#0000FF">this</span>.userRepository.GetUser(userId);</strong>
<strong class="markLine">            <span style="color:#0000FF">if</span> (userProfile == <span style="color:#0000FF">null</span>)</strong>
<strong class="markLine">            {</strong>
<strong class="markLine">                <span style="color:#0000FF">var</span> loginType = <span style="color:#0000FF">this</span>.GetClaimValue(ConfigurationConstants.IdentityProviderClaimType);</strong>
<strong class="markLine">                userProfile = <span style="color:#0000FF">new</span> UserProfile</strong>
<strong class="markLine">                {</strong>
<strong class="markLine">                    Id = userId,</strong>
<strong class="markLine">                    DisplayName = Thread.CurrentPrincipal.Identity.Name ?? <span style="color:#0000FF">string</span>.Empty,</strong>
<strong class="markLine">                    LoginType = loginType,</strong>
<strong class="markLine">                    AssociatedUserAccount =</strong>
<strong class="markLine">                        loginType.StartsWith(<span style="color:#8B0000">&quot;Facebook&quot;</span>, StringComparison.OrdinalIgnoreCase) ?</strong>
<strong class="markLine">                            <span style="color:#0000FF">this</span>.GetClaimValue(ConfigurationConstants.FacebookAccessTokenClaimType) :</strong>
<strong class="markLine">                            <span style="color:#0000FF">string</span>.Empty</strong>
<strong class="markLine">                };</strong>
<strong class="markLine"></strong>
<strong class="markLine">                <span style="color:#0000FF">this</span>.userRepository.AddOrUpdateUser(userProfile);</strong>
<strong class="markLine">            }</strong>
<strong class="markLine"></strong>
<strong class="markLine">            <span style="color:#0000FF">var</span> effectiveReturnUrl = <span style="color:#0000FF">this</span>.GetContextFromRequest();</strong>
<strong class="markLine"></strong>
<strong class="markLine">            <span style="color:#0000FF">if</span> (!<span style="color:#0000FF">string</span>.IsNullOrWhiteSpace(effectiveReturnUrl))</strong>
<strong class="markLine">            {</strong>
<strong class="markLine">                <span style="color:#0000FF">return</span> Redirect(effectiveReturnUrl);</strong>
<strong class="markLine">            }</strong>
<strong class="markLine">        }</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">return</span> Redirect(<span style="color:#8B0000">&quot;~/&quot;</span>);</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">string</span> GetContextFromRequest()</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        Uri requestBaseUrl = WSFederationMessage.GetBaseUrl(<span style="color:#0000FF">this</span>.Request.Url);</strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> message = WSFederationMessage.CreateFromNameValueCollection(requestBaseUrl, <span style="color:#0000FF">this</span>.Request.Form);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">return</span> message != <span style="color:#0000FF">null</span> ? message.Context : <span style="color:#0000FF">string</span>.Empty;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">string</span> GetClaimValue(<span style="color:#0000FF">string</span> claimType)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (!Thread.CurrentPrincipal.Identity.IsAuthenticated)</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            <span style="color:#0000FF">throw</span> <span style="color:#0000FF">new</span> InvalidOperationException(<span style="color:#8B0000">&quot;User is not authenticated&quot;</span>);</strong>
<strong class="markLine">        }</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> claimsIdentity = (IClaimsIdentity)Thread.CurrentPrincipal.Identity;</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (!claimsIdentity.Claims.Any(c =&gt; c.ClaimType.Equals(claimType, StringComparison.OrdinalIgnoreCase)))</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            <span style="color:#0000FF">throw</span> <span style="color:#0000FF">new</span> InvalidOperationException(<span style="color:#8B0000">&quot;Claim not found: &quot;</span> + claimType);</strong>
<strong class="markLine">        }</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">return</span> claimsIdentity.Claims.FirstOrDefault(c =&gt; c.ClaimType.Equals(claimType, StringComparison.OrdinalIgnoreCase)).Value;</strong>
<strong class="markLine">    }</strong>
}
</code></pre></li>
<li><p>In the <strong>AccountController</strong>, right-click <strong>LogOn</strong> action method and select <strong>Add View</strong>. Name it <em>LogOn</em> and leave the default values for the remaining fields.</p></li>
<li><p>Replace the entire code of <strong>LogOn</strong> view with the following code.</p>

<!-- mark: 1-75    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><strong class="markLine">@{</strong>
<strong class="markLine">    ViewBag.Title = &quot;Login&quot;;    </strong>
<strong class="markLine">}</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">h2</span><span style="color:#0000FF">&gt;</span>Login<span style="color:#0000FF">&lt;/</span><span style="color:#800000">h2</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">p</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    Login using any of the following identity providers:</strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">p</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;status&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">table</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;loginsTable&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">table</span><span style="color:#0000FF">&gt;</span> </strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    function getQueryVariable(variable) {</strong>
<strong class="markLine">        var query = window.location.search.substring(1);</strong>
<strong class="markLine">        var vars = query.split(&quot;&amp;&quot;);</strong>
<strong class="markLine">        for (var i = 0; i <span style="color:#0000FF">&lt;</span> vars.length; i++) {</strong>
<strong class="markLine">            var pair = vars[i].split(&quot;=&quot;);</strong>
<strong class="markLine">            if (pair[0] == variable) {</strong>
<strong class="markLine">                return pair[1];</strong>
<strong class="markLine">            }</strong>
<strong class="markLine">        }</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    jQuery(document).ready(function () {</strong>
<strong class="markLine">        var apiURL = &quot;@this.ViewBag.ApiUrl&quot;;</strong>
<strong class="markLine"></strong>
<strong class="markLine">        $(&quot;.status&quot;).text(&quot;Loading...&quot;);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        var returnUrl = getQueryVariable(&quot;ReturnUrl&quot;);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        if (returnUrl == null || returnUrl == undefined)</strong>
<strong class="markLine">            returnUrl = &quot;&quot;;</strong>
<strong class="markLine"></strong>
<strong class="markLine">        // Get login info</strong>
<strong class="markLine">        $.ajax({</strong>
<strong class="markLine">            type: &quot;GET&quot;,</strong>
<strong class="markLine">            url: apiURL + &quot;api/auth/loginselector?returnUrl=&quot; + returnUrl,</strong>
<strong class="markLine">            dataType: &quot;json&quot;,</strong>
<strong class="markLine">            success: function (result) {</strong>
<strong class="markLine">                createLoginButtons(result);</strong>
<strong class="markLine">            },</strong>
<strong class="markLine">            error: function (req, status, error) {</strong>
<strong class="markLine">                alert(error);</strong>
<strong class="markLine">            }</strong>
<strong class="markLine">        });</strong>
<strong class="markLine">    });</strong>
<strong class="markLine"></strong>
<strong class="markLine">    // Create the login button for each identity provider</strong>
<strong class="markLine">    function createLoginButtons(loginInfoList) {</strong>
<strong class="markLine">        var loginsTable = $(&#39;#loginsTable&#39;);</strong>
<strong class="markLine">        loginsTable.empty();</strong>
<strong class="markLine"></strong>
<strong class="markLine">        $(&quot;.status&quot;).text(&quot;&quot;);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        $.each(loginInfoList, function (i, loginInfo) {</strong>
<strong class="markLine">            var loginButton = $(&#39;<span style="color:#0000FF">&lt;</span><span style="color:#800000">input</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;button&quot;</span><span style="color:#0000FF">&gt;</span>&#39;);</strong>
<strong class="markLine"></strong>
<strong class="markLine">            loginButton.attr(&quot;value&quot;, loginInfo.Name);</strong>
<strong class="markLine">            loginButton.click(function () { window.location.href = loginInfo.LoginUrl; });</strong>
<strong class="markLine"></strong>
<strong class="markLine">            var loginsTableTd = $(&#39;<span style="color:#0000FF">&lt;</span><span style="color:#800000">td</span><span style="color:#0000FF">&gt;</span>&#39;);</strong>
<strong class="markLine">            loginsTableTd.append(loginButton);</strong>
<strong class="markLine"></strong>
<strong class="markLine">            var loginsTableTr = $(&#39;<span style="color:#0000FF">&lt;</span><span style="color:#800000">tr</span><span style="color:#0000FF">&gt;</span>&#39;);</strong>
<strong class="markLine">            loginsTableTr.append(loginsTableTd);</strong>
<strong class="markLine"></strong>
<strong class="markLine">            loginsTable.append(loginsTableTr);</strong>
<strong class="markLine">        });</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre>

<p>The View uses JQuery to consume the Web API <strong>AuthService</strong> to retrieve the list of available providers in the ACS namespace. Once the view has the list, one button is generated for each provider to allow users select any of the available Identity providers.</p></li>
</ol>

<p><a name="Ex1Task4"></a></p>

<h4 id="Task_4_-_Creating_a_Friends_List_View">Task 4 - Creating a Friends List View</h4>

<p>In this task, you will create a Friends list consuming the server APIs to invite and retrieve the user's friends.</p>

<ol>
<li><p>In order to interact with the Web APIs on client-side, you need to send a JSON request to the Web API URL. To do this, you will use two JavaScript files that encapsulate the calls to the APIs. Open the <strong>Game</strong> folder inside <strong>Scripts</strong> and add <strong>UserService.js</strong> and <strong>ServerInterface.js</strong> files from <strong>Assets\Scripts</strong> folder of this lab.</p></li>
<li><p>In the <strong>TicTacToe.Web</strong> project, add a new View named <strong>Friends</strong> under the <strong>Account</strong> folder.</p></li>
<li><p>Replace the entire code with the following:</p>

<!-- mark: 1-24    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><strong class="markLine">@{</strong>
<strong class="markLine">    ViewBag.Title = &quot;Your Friends&quot;;</strong>
<strong class="markLine">    Layout = &quot;~/Views/Shared/_Layout.cshtml&quot;;</strong>
<strong class="markLine">}</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">jQuery</span>.<span style="color:#FF0000">tmpl</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">knockout</span>-<span style="color:#FF0000">1</span>.<span style="color:#FF0000">2</span>.<span style="color:#FF0000">1</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">ServerInterface</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">UserService</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">h2</span><span style="color:#0000FF">&gt;</span>Your Friends<span style="color:#0000FF">&lt;/</span><span style="color:#800000">h2</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">p</span><span style="color:#0000FF">&gt;</span>Use this URL to invite other users: <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;text: inviteURL()&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">p</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">h3</span><span style="color:#0000FF">&gt;</span>Friends<span style="color:#0000FF">&lt;/</span><span style="color:#800000">h3</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&#39;template: { name: &quot;FriendList&quot;, foreach: friends() }&#39;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&#39;FriendList&#39;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&#39;text/html&#39;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">       ${$data.DisplayName} <span style="color:#0000FF">&lt;</span><span style="color:#800000">br</span><span style="color:#0000FF">&gt;</span> </strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>Add the following code at the bottom of the View. This code interacts with the <strong>UserService.js</strong> to perform JSON requests to the Web APIs. In this case, you will request for the Friends list by calling the <strong>UserService</strong> Web API.</p>

<!-- mark: 1-43    --> 

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    var userId = &quot;@this.ViewBag.CurrentUserId&quot;;</strong>
<strong class="markLine">    var BlobUrl = &quot;@this.ViewBag.BlobUrl&quot;;</strong>
<strong class="markLine">    var si = new ServerInterface();</strong>
<strong class="markLine">    var user = new UserService(userId, BlobUrl, si);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    function getFriends() {</strong>
<strong class="markLine">        user.getFriendsInfo(function (friends) {</strong>
<strong class="markLine">            window.viewModel.refreshFriends(friends);</strong>
<strong class="markLine">        }, function (req, status, error) {</strong>
<strong class="markLine">            var errorMessage;</strong>
<strong class="markLine">            if (req.responseText == undefined) {</strong>
<strong class="markLine">                errorMessage = &quot;POST Error:\nreq:&quot; + req + &quot;\nstatus:&quot; + status + &quot;\nerror:&quot; + error;</strong>
<strong class="markLine">            }</strong>
<strong class="markLine">            else {</strong>
<strong class="markLine">                errorMessage = &quot;POST Error:\nreq:&quot; + req.responseText + &quot;\nstatus:&quot; + status + &quot;\nerror:&quot; + error;</strong>
<strong class="markLine">            }</strong>
<strong class="markLine">            alert(errorMessage);</strong>
<strong class="markLine">        });</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    function ViewModel() {</strong>
<strong class="markLine">        this.user = ko.observable(userId);</strong>
<strong class="markLine">        this.friends = ko.observableArray();</strong>
<strong class="markLine">        this.notifications = ko.observableArray();        </strong>
<strong class="markLine">        this.inviteURL = ko.observable(document.location.href + &quot;/?id=&quot; + encodeURIComponent(userId));</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    ViewModel.prototype.refreshFriends = function (friends) {</strong>
<strong class="markLine">        for (n in friends)</strong>
<strong class="markLine">            this.friends.push(friends[n]);</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    jQuery(document).ready(function () {</strong>
<strong class="markLine">        window.viewModel = new ViewModel();</strong>
<strong class="markLine"></strong>
<strong class="markLine">        ko.applyBindings(window.viewModel);</strong>
<strong class="markLine">        user.getFriendsInfo(</strong>
<strong class="markLine">            function (friends) { window.viewModel.refreshFriends(friends); },</strong>
<strong class="markLine">            function () { alert(&#39;Error Get Friends&#39;); });   </strong>
<strong class="markLine">    });</strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>Open <strong>GameService.cs</strong> located at the <strong>Services</strong> folder. Replace the contents of the method <strong>Invite</strong> with the following highlighted code:</p>

<p>(Code Snippet - <em>Building a Social Game - Ex1 Invite Method - CS</em>)</p>

<!-- mark: 3-9    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> Invite(Guid gameQueueId, dynamic formContent)
{
<strong class="markLine">    <span style="color:#0000FF">var</span> users = formContent.users != <span style="color:#0000FF">null</span> ?</strong>
<strong class="markLine">                ((JsonArray)formContent.users).ToObjectArray().Select(o =&gt; o.ToString()).ToList() :</strong>
<strong class="markLine">                <span style="color:#0000FF">null</span>;</strong>
<strong class="markLine">    <span style="color:#0000FF">string</span> message = formContent.message != <span style="color:#0000FF">null</span> ? formContent.message.Value : <span style="color:#0000FF">null</span>;</strong>
<strong class="markLine">    <span style="color:#0000FF">string</span> url = formContent.url != <span style="color:#0000FF">null</span> ? formContent.url.Value : <span style="color:#0000FF">null</span>;</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.gameRepository.Invite(<span style="color:#0000FF">this</span>.CurrentUserId, gameQueueId, message, url, users);</strong>
}
</code></pre></li>
<li><p>Open the <strong>_Layout.cshtml</strong> View located in the <strong>Shared</strong> folder under <strong>Views</strong>.</p></li>
<li><p>Add a new menu item that points to the recently created <strong>Friends</strong> view.</p>

<!-- mark: 5    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><span style="color:#0000FF">&lt;</span><span style="color:#800000">nav</span><span style="color:#0000FF">&gt;</span>
    <span style="color:#0000FF">&lt;</span><span style="color:#800000">ul</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;menu&quot;</span><span style="color:#0000FF">&gt;</span>
        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>@Html.ActionLink(&quot;Home&quot;, &quot;Index&quot;, &quot;Home&quot;, new { area = &quot;&quot; }, null)<span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>
        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>@Html.ActionLink(&quot;Tic Tac Toe&quot;, &quot;Index&quot;, &quot;TicTacToe&quot;, new { area = &quot;&quot; }, null)<span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>@Html.ActionLink(&quot;Friends&quot;, &quot;Friends&quot;, &quot;Account&quot;, new { area = &quot;&quot; }, null)<span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span></strong>
    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">ul</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;/</span><span style="color:#800000">nav</span><span style="color:#0000FF">&gt;</span>
</code></pre></li>
<li><p>Now you will add a method in the <strong>AccountController</strong> to retrieve the friends to the view. The Friends View provides you with an invitation URL, which is no more than the same URL with a user Id as a parameter. If the Id is provided, the <em>Friend</em> relationship is saved in an Azure blob container and it will appear in your friends list.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex1 AccountController Friends - CS</em>)</p>

<!-- mark: 1-16    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine">[Authorize]</strong>
<strong class="markLine"><span style="color:#0000FF">public</span> ActionResult Friends(<span style="color:#0000FF">string</span> id)</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    <span style="color:#0000FF">if</span> (!<span style="color:#0000FF">string</span>.IsNullOrEmpty(id))</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">string</span> currentUserId = <span style="color:#0000FF">this</span>.userProvider.UserId;</strong>
<strong class="markLine">        <span style="color:#0000FF">string</span> inviteUserId = id;</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.userRepository.AddFriend(currentUserId, inviteUserId);</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.userRepository.AddFriend(inviteUserId, currentUserId);</strong>
<strong class="markLine">        <span style="color:#0000FF">return</span> RedirectToAction(<span style="color:#8B0000">&quot;Index&quot;</span>, <span style="color:#8B0000">&quot;Home&quot;</span>);</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.ViewBag.CurrentUserId = <span style="color:#0000FF">this</span>.userProvider.UserId;</strong>
<strong class="markLine">    <span style="color:#0000FF">return</span> View();</strong>
<strong class="markLine">}</strong>
</code></pre></li>
<li><p>Press <strong>CTRL+SHIFT+B</strong> to build the solution.</p></li>
</ol>

<p><a name="Ex1Verification"></a></p>

<h4 id="Verification">Verification</h4>
<blockquote>
<p><strong>Note:</strong> Before you execute the solution, make sure that the start-up project and the start-up page are set. </p>

<p>To set the startup project, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web.Azure</strong> project and select <strong>Set as StartUp Project</strong>.</p>

<p>To designate the start page, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web</strong> project and select <strong>Properties</strong>. In the <strong>Properties</strong> window, select the <strong>Web</strong> tab and in the <strong>Start Action</strong>, select <strong>Specific Page</strong>. Set the value of this field empty.</p>
</blockquote>
<ol>
<li><p>Press to <strong>F5</strong> to run the solution.</p>

<p><img src="images/tic-tac-toe-home-page.png?raw=true" alt="Tic-Tac-Toe Home Page" />
</p>

<p><em>Tic-Tac-Toe Home Page</em></p></li>
<li><p>In the <strong>Home</strong> page menu, click <strong>Tic Tac Toe</strong>. The browser will redirect you to the <strong>LogOn</strong> view.</p></li>
<li><p>Select <strong>Windows Live Id</strong> as the identity provider.</p>

<p><img src="images/selecting-an-identity-provider.png?raw=true" alt="Selecting an identity provider" />
</p>

<p><em>Selecting an identity provider</em></p></li>
<li><p>You will be redirected to the <strong>Microsoft Account</strong> login page. Enter your credentials and log on. The page will redirect you back to the Tic-Tac-Toe game.</p></li>
<li><p>Now that you are authenticated, go to the <strong>Friends</strong> page by clicking <strong>Friends</strong> link in the menu.</p></li>
<li><p>As this is the first time you run the application with the Web APIs, the Friends list will be empty. Copy the Invitation URL.</p>

<p><img src="images/copying-the-invitation-url.png?raw=true" alt="Copying the Invitation URL" />
</p>

<p><em>Copying the Invitation URL</em></p></li>
<li><p>Open a new session in <strong>Internet Explorer</strong> or an <strong>In-Private</strong> session by pressing <strong>CTRL+SHIFT+P</strong>.</p></li>
<li><p>Paste the invitation URL in the browse and press enter. In the <strong>LogOn</strong> view, log on with a different account.</p></li>
<li><p>Go to the <strong>Friends</strong> page. In the Friends list, you will see the user id of your first account.</p>

<p><img src="images/showing-the-friends-user-id.png?raw=true" alt="Showing the Friend's user id" />
</p>

<p><em>Showing the Friend's user id</em></p></li>
<li><p>Go back to the first browser session, and refresh the <strong>Friends</strong> page. You will see the user id of the second account.</p></li>
</ol>

<p><a name="Exercise2"></a></p>

<h3 id="Exercise_2_Enable_Multiplayer_with_Storage_Polling">Exercise 2: Enable Multiplayer with Storage Polling</h3>

<p>In this exercise, you will enable multiplayer for the Tic-Tac-Toe using the Storage Polling approach. This consists in querying a Blob container for game updates and rendering the result in the board. Additionally, you will learn how to invite another user to play a Tic-Tac-Toe game.</p>

<p><a name="Ex2Task1"></a></p>

<h4 id="Task_1_-_Implementing_Multiplayer">Task 1 - Implementing Multiplayer</h4>

<p>In this task, you will add multiplayer features to the Tic Tac Toe view. To do this, you will update the client-side scripts and modify the view to interact with the game service.</p>

<ol>
<li><p>Open the <strong>Begin.sln</strong> solution located in the folder <strong>\Source\Ex2-AMultiplayerPolling\Begin</strong>. You can alternatively continue working with the solution obtained by completing Exercise 1.</p></li>
<li><p>Open the <strong>TicTacToeController</strong> class located in the <strong>Controllers</strong> folder and inherit it from <strong>BaseController</strong>.</p>

<!-- mark: 1    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> TicTacToeController : BaseController</strong>
{
    ...
}
</code></pre></li>
<li><p>In the <strong>TicTacToe.Web</strong> project, add the <strong>GameService.js</strong> file located in the <strong>Assets\Scripts</strong> folder of this lab, to the <strong>Scripts\Game</strong> folder.</p></li>
<li><p>Expand the <strong>TicTacToe</strong> folder under <strong>Scripts\Game</strong>, and add the files <strong>Controller.js</strong> and <strong>ViewModel.js</strong> located in the <strong>Assets\Scripts</strong> folder of this lab. When asked, confirm to replace the old files.</p></li>
<li><p>Open the <strong>Index.cshtml</strong> view in the <strong>Views\TicTacToe</strong> folder of the Web project.</p></li>
<li><p>Add the following references to the core client-side JavaScript files.</p>

<!-- mark: 3-5    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">jQuery</span>.<span style="color:#FF0000">tmpl</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">knockout</span>-<span style="color:#FF0000">1</span>.<span style="color:#FF0000">2</span>.<span style="color:#FF0000">1</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">ServerInterface</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">GameService</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">UserService</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">TicTacToe</span>/<span style="color:#FF0000">Board</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">TicTacToe</span>/<span style="color:#FF0000">Game</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">TicTacToe</span>/<span style="color:#FF0000">ViewModel</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">TicTacToe</span>/<span style="color:#FF0000">Controller</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
</code></pre></li>
<li><p>Add the following code at the beginning of the <strong>div</strong> element with Id <strong>game</strong>. This code renders the Invitation URL and the list of players that are in the queue waiting to play.</p>

<!-- mark: 1-32    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">style</span>=<span style="color:#0000FF">&quot;display: none&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: gameQueueId() != null&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span>Player<span style="color:#0000FF">&lt;/</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            Welcome <span style="color:#0000FF">&lt;</span><span style="color:#800000">b</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;text: playerName()&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">b</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: isOwner() &amp;&amp; gameQueueId() != null &amp;&amp; gameId() == null&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span>Use this URL to invite other players: <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;text: inviteURL()&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;/</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">br</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: friends() != null &amp;&amp; friends().length &gt; 0&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            Your Friends</strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">select</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;friends&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;options: friends, optionsValue: &#39;Id&#39;, optionsText: &#39;DisplayName&#39;&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;/</span><span style="color:#800000">select</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                <span style="color:#0000FF">&lt;</span><span style="color:#800000">a</span> <span style="color:#FF0000">href</span>=<span style="color:#0000FF">&quot;#&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;click: inviteFriend&quot;</span><span style="color:#0000FF">&gt;</span>Invite Friend<span style="color:#0000FF">&lt;/</span><span style="color:#800000">a</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">br</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: noPlayers() == 1 &amp;&amp; isOwner()&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span>Waiting for your opponent...<span style="color:#0000FF">&lt;/</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">style</span>=<span style="color:#0000FF">&quot;display: none&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: gameQueueId() != null&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span>Players<span style="color:#0000FF">&lt;/</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&#39;template: { name: &quot;queueStatus&quot;, foreach: players()}&#39;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;queueStatus&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/html&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;</span><span style="color:#800000">b</span><span style="color:#0000FF">&gt;</span>${$data.UserName}<span style="color:#0000FF">&lt;/</span><span style="color:#800000">b</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>Locate the <strong>div</strong> which contains the legend <strong>Game</strong>, and replace it with the following:</p>

<!-- mark: 1-20    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">style</span>=<span style="color:#0000FF">&quot;display: none&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: gameId() != null&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span>Game<span style="color:#0000FF">&lt;/</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            You are <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: playerColor() == TTTColor.Cross&quot;</span><span style="color:#0000FF">&gt;</span>Xs<span style="color:#0000FF">&lt;/</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span> <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span></strong>
<strong class="markLine">                <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: playerColor() == TTTColor.Circle&quot;</span><span style="color:#0000FF">&gt;</span>Os<span style="color:#0000FF">&lt;/</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: playerColor() == currentColor()&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            Your turn!<span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: playerColor() != currentColor()&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            Opponent turn!<span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: isTie()&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            Tie!!<span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: playerColor() == winnerColor()&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            You won!!<span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: playerColor() != winnerColor() &amp;&amp; winnerColor() != TTTColor.Empty&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            You lose!!<span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">canvas</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;board&quot;</span> <span style="color:#FF0000">width</span>=<span style="color:#0000FF">&quot;300&quot;</span> <span style="color:#FF0000">height</span>=<span style="color:#0000FF">&quot;300&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">canvas</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>Locate the <strong>script</strong> block and insert the following code at the beginning.</p>

<!-- mark: 1-22    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine"><span style="color:#0000FF">var</span> viewModel;</strong>
<strong class="markLine"><span style="color:#0000FF">var</span> gameQueueId = getQueryVariable(<span style="color:#8B0000">&quot;id&quot;</span>);</strong>
<strong class="markLine"><span style="color:#0000FF">var</span> nullGameId = <span style="color:#8B0000">&quot;00000000-0000-0000-0000-000000000000&quot;</span>;</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">function</span> getQueryVariable(variable) {</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> query = <span style="color:#0000FF">window</span>.<span style="color:#0000FF">location</span>.search.substring(1);</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> vars = query.split(<span style="color:#8B0000">&quot;&amp;&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">for</span> (<span style="color:#0000FF">var</span> i = 0; i &lt; vars.<span style="color:#0000FF">length</span>; i++) {</strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> pair = vars[i].split(<span style="color:#8B0000">&quot;=&quot;</span>);</strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (pair[0] == variable) {</strong>
<strong class="markLine">            <span style="color:#0000FF">return</span> pair[1];</strong>
<strong class="markLine">        }</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">}</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">var</span> apiURL = <span style="color:#8B0000">&quot;@this.ViewBag.ApiUrl&quot;</span>;</strong>
<strong class="markLine"><span style="color:#0000FF">var</span> blobURL = <span style="color:#8B0000">&quot;@this.ViewBag.BlobUrl&quot;</span>;</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">var</span> si = <span style="color:#0000FF">new</span> ServerInterface();</strong>
<strong class="markLine"><span style="color:#0000FF">var</span> gs = <span style="color:#0000FF">new</span> GameService(apiURL, blobURL, si);</strong>
<strong class="markLine"><span style="color:#0000FF">var</span> user = <span style="color:#0000FF">new</span> UserService(apiURL, blobURL, si);</strong>
</code></pre></li>
<li><p>Next to the previously inserted code, add the following:</p>

<!-- mark: 1-21    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine"><span style="color:#0000FF">function</span> start(userId) {</strong>
<strong class="markLine">    <span style="color:#008000">// check for canvas, show an &quot;Upgrade your browser&quot; screen if they don&#39;t have it.</span></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> canvas = <span style="color:#0000FF">document</span>.getElementById(&#39;board&#39;);</strong>
<strong class="markLine">    <span style="color:#0000FF">if</span> (canvas.getContext == <span style="color:#0000FF">null</span> || canvas.getContext(&#39;2d&#39;) == <span style="color:#0000FF">null</span>) {</strong>
<strong class="markLine">        $(<span style="color:#8B0000">&quot;#game&quot;</span>).toggle();</strong>
<strong class="markLine">        $(<span style="color:#8B0000">&quot;#notSupported&quot;</span>).toggle();</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">return</span>;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> board = <span style="color:#0000FF">new</span> TicTacToeBoard(canvas);</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> game = <span style="color:#0000FF">new</span> TicTacToeGame();</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> controller = <span style="color:#0000FF">new</span> TicTacToeController(viewModel, gs, board, game);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    controller.setGameQueueId(gameQueueId);</strong>
<strong class="markLine">    controller.start();</strong>
<strong class="markLine">    user.getFriendsInfo(<span style="color:#0000FF">function</span> (friends) { viewModel.friends(friends); });</strong>
<strong class="markLine">    user.getUser(userId, <span style="color:#0000FF">function</span> () { });</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">window</span>.onbeforeunload = <span style="color:#0000FF">function</span> () { controller.finish(); };</strong>
<strong class="markLine">}</strong>
</code></pre></li>
<li><p>Replace the body of the <strong>$(function ())</strong> method with the following.</p>

<!-- mark: 2-12    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript">$(<span style="color:#0000FF">function</span> () {
<strong class="markLine">    viewModel = <span style="color:#0000FF">new</span> TicTacToeViewModel();</strong>
<strong class="markLine">    ko.applyBindings(viewModel);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    user.verify(</strong>
<strong class="markLine">        <span style="color:#0000FF">function</span> (userId) { start(userId); },</strong>
<strong class="markLine">        <span style="color:#0000FF">function</span> () {</strong>
<strong class="markLine">            <span style="color:#0000FF">var</span> newlocation = &#39;@Url.Action(<span style="color:#8B0000">&quot;LogOn&quot;</span>, <span style="color:#8B0000">&quot;Account&quot;</span>, <span style="color:#0000FF">new</span> { Area = <span style="color:#8B0000">&quot;&quot;</span>, ReturnUrl = <span style="color:#8B0000">&quot;replace-in-js&quot;</span> })&#39;;</strong>
<strong class="markLine">            newlocation = newlocation.replace(<span style="color:#8B0000">&quot;replace-in-js&quot;</span>, encodeURIComponent(<span style="color:#0000FF">window</span>.<span style="color:#0000FF">location</span>.href));</strong>
<strong class="markLine">            <span style="color:#0000FF">window</span>.<span style="color:#0000FF">location</span>.assign(newlocation);</strong>
<strong class="markLine">        }</strong>
<strong class="markLine">    );</strong>
});
</code></pre></li>
<li><p>Add the following two methods to the script block.</p>

<!-- mark: 1-12    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine"><span style="color:#0000FF">function</span> inviteFriend() {</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> userId = $(<span style="color:#8B0000">&quot;#friends&quot;</span>).val();</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> userName = $(<span style="color:#8B0000">&quot;#friends :selected&quot;</span>).text();</strong>
<strong class="markLine">    gs.inviteUser(viewModel.gameQueueId(), userId, <span style="color:#8B0000">&quot;Invitation for Tic Tac Toe&quot;</span>, viewModel.inviteURL(), <span style="color:#0000FF">function</span> () { <span style="color:#0000FF">alert</span>(userName + <span style="color:#8B0000">&quot; was invited&quot;</span>) });</strong>
<strong class="markLine">}</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">function</span> sgusersCallback(user) {</strong>
<strong class="markLine">    <span style="color:#0000FF">if</span> (user.DisplayName != <span style="color:#0000FF">null</span> &amp;&amp; user.DisplayName != <span style="color:#8B0000">&quot;&quot;</span>)</strong>
<strong class="markLine">        viewModel.playerName(user.DisplayName);</strong>
<strong class="markLine">    <span style="color:#0000FF">else</span></strong>
<strong class="markLine">        viewModel.playerName(user.Id);</strong>
<strong class="markLine">}</strong>
</code></pre></li>
</ol>

<p><a name="Ex2Task2"></a></p>

<h4 id="Task_2_-_Adding_Worker_Role_to_Enable_Game_Invitations">Task 2 - Adding Worker Role to Enable Game Invitations</h4>

<p>In this task, you will add an existing project that will be in charge of processing invitation requests.</p>

<ol>
<li><p>Copy the folder <strong>\Source\Assets\SocialGames.Worker</strong> to the root of your project folder.</p>

<p><img src="images/copying-the-worker-to-the-project-folder.png?raw=true" alt="Copying the worker to the project folder" />
</p>

<p><em>Copying the worker to the project folder</em></p></li>
<li><p>Add the project <strong>SocialGames.Worker.csproj</strong> located in the folder you copied (<strong>\SocialGames.Worker\</strong>) to the solution.</p></li>
<li><p>In the <strong>TicTacToe.Web.Azure</strong> cloud project, associate the recently added project as a Worker Role in the <strong>Roles</strong> folder.</p></li>
<li><p>Open the role <strong>Properties</strong> for the <strong>SocialGames.Worker</strong> and add a new setting with <strong>Name</strong> <em>DataConnectionString</em>, set the <strong>Type</strong> to <em>Connection String</em> and for <strong>Value</strong> choose <strong>Windows Azure Storage Emulator</strong>. Save and close the <strong>Properties</strong> page.</p></li>
</ol>

<p><a name="Ex2Task3"></a></p>

<h4 id="Task_3_-_Showing_Game_Invitation_Messages_from_Friends">Task 3 - Showing Game Invitation Messages from Friends</h4>

<p>In this task, you will update the <strong>Friends</strong> view to show the invitation messages from other users.</p>

<ol>
<li><p>Open the <strong>Friends</strong> view located in <strong>Views\Account</strong> folder of the Web project.</p></li>
<li><p>Add the <strong>Invitations</strong> table below the script block with id <strong>FriendList</strong>.</p>

<!-- mark: 1-19    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine">&lt;h3&gt;Invitations&lt;/h3&gt;</strong>
<strong class="markLine">&lt;table&gt;</strong>
<strong class="markLine">    &lt;thead&gt;</strong>
<strong class="markLine">        &lt;tr&gt;</strong>
<strong class="markLine">            &lt;th&gt;Message&lt;/th&gt;</strong>
<strong class="markLine">            &lt;th&gt;From&lt;/th&gt;</strong>
<strong class="markLine">            &lt;th&gt;Action&lt;/th&gt;</strong>
<strong class="markLine">        &lt;/tr&gt;</strong>
<strong class="markLine">    &lt;/thead&gt;</strong>
<strong class="markLine">    &lt;tbody data-bind=&#39;template: { <span style="color:#0000FF">name</span>: <span style="color:#8B0000">&quot;NotificationList&quot;</span>, foreach: notifications() }&#39; /&gt;</strong>
<strong class="markLine">&lt;/table&gt;</strong>
<strong class="markLine"></strong>
<strong class="markLine">&lt;script id=<span style="color:#8B0000">&quot;NotificationList&quot;</span> type=<span style="color:#8B0000">&quot;text/html&quot;</span>&gt;</strong>
<strong class="markLine">&lt;tr&gt;</strong>
<strong class="markLine">       &lt;td&gt;${$data.Message} &lt;/td&gt; </strong>
<strong class="markLine">       &lt;td&gt;${$data.SenderName} &lt;/td&gt;</strong>
<strong class="markLine">       &lt;td&gt;&lt;a href=<span style="color:#8B0000">&quot;${$data.Url}&quot;</span>&gt;Go&lt;/a&gt; &lt;/td&gt; </strong>
<strong class="markLine">&lt;/tr&gt;</strong>
<strong class="markLine">&lt;/script&gt;</strong>
</code></pre></li>
<li><p>Add a call to the <strong>user.getNotifications</strong> method at the end of <strong>jQuery</strong> <strong>ready</strong> function within the script block in order to retrieve the game invitation messages.</p>

<!-- mark: 9    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript">jQuery(<span style="color:#0000FF">document</span>).ready(<span style="color:#0000FF">function</span> () {
    <span style="color:#0000FF">window</span>.viewModel = <span style="color:#0000FF">new</span> ViewModel();

    ko.applyBindings(<span style="color:#0000FF">window</span>.viewModel);
    user.getFriendsInfo(
        <span style="color:#0000FF">function</span> (friends) { <span style="color:#0000FF">window</span>.viewModel.refreshFriends(friends); },
        <span style="color:#0000FF">function</span> () { <span style="color:#0000FF">alert</span>(&#39;Error Get Friends&#39;); });

<strong class="markLine">    user.getNotifications(userId, <span style="color:#0000FF">function</span> () { });</strong>
});
</code></pre></li>
<li><p>Add a callback method at the end of the block script. This method is used by the <strong>UserService</strong> to return the invitation messages.</p>

<!-- mark: 1-11    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine"><span style="color:#0000FF">function</span> sgnotificationsCallback(data) {</strong>
<strong class="markLine">    <span style="color:#0000FF">for</span> (<span style="color:#0000FF">var</span> n <span style="color:#0000FF">in</span> data.Notifications) {</strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> notification = data.Notifications[n];</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (notification.SenderName == <span style="color:#0000FF">null</span> || notification.SenderName == <span style="color:#8B0000">&quot;&quot;</span>)</strong>
<strong class="markLine">            notification.SenderName = notification.SenderId;</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (notification.Type == <span style="color:#8B0000">&quot;Invite&quot;</span>)</strong>
<strong class="markLine">            viewModel.notifications.push(notification);</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">}</strong>
</code></pre></li>
</ol>

<p><a name="Ex2Verification"></a></p>

<h4 id="Verification">Verification</h4>
<blockquote>
<p><strong>Note:</strong> Before you execute the solution, make sure that the start-up project and the start-up page are set. </p>

<p>To set the startup project, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web.Azure</strong> project and select <strong>Set as StartUp Project</strong>.</p>

<p>To designate the start page, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web</strong> project and select <strong>Properties</strong>. In the <strong>Properties</strong> window, select the <strong>Web</strong> tab and in the <strong>Start Action</strong>, select <strong>Specific Page</strong>. Set the value of this field empty.</p>
</blockquote>
<ol>
<li><p>Press to <strong>F5</strong> to run the solution.</p></li>
<li><p>Click the <strong>Tic Tac Toe</strong> menu link and log on with an identity provider. You will see the current list of Players that are in the same game queue. Additionally, an invitation URL will be generated. Copy this URL.</p>

<p><img src="images/listing-players-and-the-auto-generated-invita.png?raw=true" alt="Listing players and the auto generated invitation URL" />
</p>

<p><em>Listing players and the auto generated invitation URL</em></p></li>
<li><p>Open a new session in <strong>Internet Explorer</strong> or an <strong>In-Private</strong> session by pressing <strong>CTRL+SHIFT+P</strong> without closing the current one.</p></li>
<li><p>Paste the invitation URL. When prompted, enter other credentials to log on. Now, the list of players will show both users. Check the first browser to verify that both users are listed as well.</p>

<p><img src="images/playing-a-multiplayer-tic-tac-toe.png?raw=true" alt="Playing a multiplayer Tic-Tac-Toe" />
</p>

<p><em>Playing a multiplayer Tic-Tac-Toe</em></p></li>
<li><p>Start playing the game. You will see how the browsers are updated after each move.</p></li>
<li><p>Restart the game by clicking the <strong>Tic Tac Toe</strong> menu link in the first browser. You will see a new drop-down list that shows your friends.</p>

<p><img src="images/listing-friends.png?raw=true" alt="Listing friends" />
</p>

<p><em>Listing friends</em></p></li>
<li><p>Click the <strong>Invite Friend</strong> link. A confirmation message will appear. Click <strong>OK</strong>.</p>

<p><img src="images/invite-a-friend-confirmation.png?raw=true" alt="Invite a friend confirmation" />
</p>

<p><em>Invite a friend confirmation</em></p></li>
<li><p>In the second browser, click the <strong>Friends</strong> link. The <strong>Invitations</strong> table will show a new message from the other user. The message has a link that takes you to the Tic Tac Toe page with the game queue Id. Click the <strong>Go</strong> link.</p>

<p><img src="images/invitation-message.png?raw=true" alt="Invitation Message" />
</p>

<p><em>Invitation Message</em></p></li>
<li><p>The link takes you to the Tic Tac Toe page and a new game will be started.</p></li>
<li><p>Close the browsers.</p></li>
</ol>

<p><a name="Exercise3"></a></p>

<h3 id="Exercise_3_Enable_Multiplayer_with_NodeJs">Exercise 3: Enable Multiplayer with Node.Js</h3>

<p>In this exercise, you will enable multiplayer for the Tic-Tac-Toe game using a different approach than the one from Exercise 2. Instead of querying the storage for updates, you will start a <strong>Node.JS</strong> Worker Role node that enables communication between Web clients by broadcasting incoming messages between connected clients. To do this, Node.JS uses a module named <strong>Socket.IO</strong> that opens Web Sockets between the client browser and the Node server. This way, the client browser <em>emits</em> a message to the Server, which is then <em>broadcasted</em> to other clients (in this case, the other player's browser).</p>

<p>To enable multiplayer, <strong>Node.JS</strong> and <strong>Socket.IO</strong> allows you to send the game's actions to the other player in real-time, without needing to poll the game status.</p>

<p><a name="Ex3Task1"></a></p>

<h4 id="Task_1_-_Adding_NodeJS_Worker_Role_to_Enable_Multiplayer_Games">Task 1 - Adding Node.JS Worker Role to Enable Multiplayer Games</h4>

<p>In this task, you will add an existing project that includes a Node.JS Worker Role.</p>

<ol>
<li><p>Open the <strong>Begin.sln</strong> solution located in the folder <strong>\Source\Ex3-UsingNodeJs\Begin</strong>. You can alternatively continue working with the solution obtained by completing Exercise 1.</p></li>
<li><p>Copy the folder <strong>Source\Assets\SocialGames.WorkerNodeJs</strong> to the root of your project.</p>

<p><img src="images/copying-the-workernodejs-project.png?raw=true" alt="Copying the WorkerNodeJs project" />
</p>

<p><em>Copying the WorkerNodeJs project</em></p></li>
<li><p>Add the project <strong>SocialGames.WorkerNodeJs.csproj</strong> located in the folder you have recently added to the Solution.</p></li>
<li><p>In the <strong>TicTacToe.Web.Azure</strong> cloud project, associate the recently added project as a Worker Role in the <strong>Roles</strong> folder.</p></li>
<li><p>Open the role <strong>Properties</strong> for the <strong>SocialGames.Worker</strong> and add a new setting with <strong>Name</strong> <em>DataConnectionString</em>, set the <strong>Type</strong> <em>Connection String</em> and for <strong>Value</strong> choose <strong>Windows Azure Storage Emulator</strong>. Save and close the <strong>Properties</strong> page.</p></li>
<li><p>Open the <strong>ServiceDefinition.csdef</strong> file and replace the <strong>WorkerRole</strong> block with the following:</p>

<!-- mark: 1-24    -->

<span class="codelanguage">XML</span><pre><code class="XML"><strong class="markLine"> <span style="color:#0000FF">&lt;</span><span style="color:#800000">WorkerRole</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;SocialGames.Worker&quot;</span> <span style="color:#FF0000">vmsize</span>=<span style="color:#0000FF">&quot;Small&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;</span><span style="color:#800000">Imports</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">     <span style="color:#0000FF">&lt;</span><span style="color:#800000">Import</span> <span style="color:#FF0000">moduleName</span>=<span style="color:#0000FF">&quot;Diagnostics&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;/</span><span style="color:#800000">Imports</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;</span><span style="color:#800000">Startup</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">     <span style="color:#0000FF">&lt;</span><span style="color:#800000">Task</span> <span style="color:#FF0000">commandLine</span>=<span style="color:#0000FF">&quot;installSocketIO.cmd&quot;</span> <span style="color:#FF0000">executionContext</span>=<span style="color:#0000FF">&quot;elevated&quot;</span> <span style="color:#FF0000">taskType</span>=<span style="color:#0000FF">&quot;simple&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;/</span><span style="color:#800000">Startup</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;</span><span style="color:#800000">Endpoints</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">     <span style="color:#0000FF">&lt;</span><span style="color:#800000">InputEndpoint</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;HttpIn&quot;</span> <span style="color:#FF0000">protocol</span>=<span style="color:#0000FF">&quot;tcp&quot;</span> <span style="color:#FF0000">port</span>=<span style="color:#0000FF">&quot;8080&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;/</span><span style="color:#800000">Endpoints</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;</span><span style="color:#800000">Runtime</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">     <span style="color:#0000FF">&lt;</span><span style="color:#800000">Environment</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">       <span style="color:#0000FF">&lt;</span><span style="color:#800000">Variable</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;PORT&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">         <span style="color:#0000FF">&lt;</span><span style="color:#800000">RoleInstanceValue</span> <span style="color:#FF0000">xpath</span>=<span style="color:#0000FF">&quot;/RoleEnvironment/CurrentInstance/Endpoints/Endpoint[@name=&#39;HttpIn&#39;]/@port&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">       <span style="color:#0000FF">&lt;/</span><span style="color:#800000">Variable</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">       <span style="color:#0000FF">&lt;</span><span style="color:#800000">Variable</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;EMULATED&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">         <span style="color:#0000FF">&lt;</span><span style="color:#800000">RoleInstanceValue</span> <span style="color:#FF0000">xpath</span>=<span style="color:#0000FF">&quot;/RoleEnvironment/Deployment/@emulated&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">       <span style="color:#0000FF">&lt;/</span><span style="color:#800000">Variable</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">     <span style="color:#0000FF">&lt;/</span><span style="color:#800000">Environment</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;/</span><span style="color:#800000">Runtime</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;</span><span style="color:#800000">ConfigurationSettings</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">     <span style="color:#0000FF">&lt;</span><span style="color:#800000">Setting</span> <span style="color:#FF0000">name</span>=<span style="color:#0000FF">&quot;DataConnectionString&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">   <span style="color:#0000FF">&lt;/</span><span style="color:#800000">ConfigurationSettings</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"> <span style="color:#0000FF">&lt;/</span><span style="color:#800000">WorkerRole</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre>
<blockquote>
<p><strong>Note:</strong> The Node.JS Worker Role requires a Startup task in order to install the required module <strong>Socket.IO</strong>. The script automatically download and install the NPM in the application root of Node.JS.</p>
</blockquote></li>
<li><p>In the <strong>TicTacToe.Web</strong> project, add the <strong>GameService.js</strong> file located in the <strong>Assets\NodeJS</strong> folder of this lab, to the <strong>Scripts\Game</strong> folder. Additionally, add the <strong>socket.io.js</strong> to the root of the <strong>Scripts</strong> folder of the same project.</p></li>
<li><p>Expand the <strong>TicTacToe</strong> folder under <strong>Scripts\Game</strong>, and add the files <strong>Controller.js</strong> and <strong>ViewModel.js</strong> located in the <strong>Assets\NodeJS</strong> folder of this lab. When asked, confirm to replace the old files.</p></li>
<li><p>Open <strong>Web.config</strong> located at the root of the project and add a new setting under the <strong>appSettings</strong> node. Set its <strong>name</strong> to <em>NodeJsUrl</em> and its <strong>value</strong> to <em><a href="http://127.0.0.1:8080/">http://127.0.0.1:8080/</a></em>.</p>

<!-- mark: 3    -->

<span class="codelanguage">XML</span><pre><code class="XML"><span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">key</span>=<span style="color:#0000FF">&quot;ApiUrl&quot;</span> <span style="color:#FF0000">value</span>=<span style="color:#0000FF">&quot;http://127.0.0.1:81/&quot;</span> <span style="color:#0000FF">/&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">key</span>=<span style="color:#0000FF">&quot;BlobUrl&quot;</span> <span style="color:#FF0000">value</span>=<span style="color:#0000FF">&quot;http://127.0.0.1:10000/devstoreaccount1/&quot;</span> <span style="color:#0000FF">/&gt;</span>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">add</span> <span style="color:#FF0000">key</span>=<span style="color:#0000FF">&quot;NodeJsUrl&quot;</span> <span style="color:#FF0000">value</span>=<span style="color:#0000FF">&quot;http://127.0.0.1:8080/&quot;</span><span style="color:#0000FF">/&gt;</span></strong>
</code></pre></li>
</ol>

<p><a name="Ex3Task2"></a> </p>

<h4 id="Task_2_-Implementing_Multiplayer_with_NodeJS">Task 2 -Implementing Multiplayer with Node.JS</h4>

<p>In this task, you will update the client-side scripts to be able to play a game with two client browsers.</p>

<ol>
<li><p>First, replace the <strong>TicTacToeController</strong> class located in the <strong>Controllers</strong> folder, to inherit from the <strong>BaseController</strong> and send the API URLs using the <strong>ViewBag</strong>.</p>

<!-- mark: 1-16    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> TicTacToeController : BaseController</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    [Authorize]</strong>
<strong class="markLine">    <span style="color:#0000FF">public</span> ActionResult Index()</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.SetConfigurationData();</strong>
<strong class="markLine">        <span style="color:#0000FF">return</span> View();</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">private</span> <span style="color:#0000FF">void</span> SetConfigurationData()</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.ViewBag.BlobUrl = System.Configuration.ConfigurationManager.AppSettings[<span style="color:#8B0000">&quot;BlobUrl&quot;</span>];</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.ViewBag.ApiUrl = System.Configuration.ConfigurationManager.AppSettings[<span style="color:#8B0000">&quot;ApiUrl&quot;</span>];</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.ViewBag.NodeJsUrl = System.Configuration.ConfigurationManager.AppSettings[<span style="color:#8B0000">&quot;NodeJsUrl&quot;</span>];</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">}</strong>
</code></pre></li>
<li><p>Open the <strong>Index.cshtml</strong> view in the <strong>Views\TicTacToe</strong> folder of the Web project.</p></li>
<li><p>Add the following highlighted references to the core client-side JavaScript files.</p>

<!-- mark: 3-6    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">jQuery</span>.<span style="color:#FF0000">tmpl</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">knockout</span>-<span style="color:#FF0000">1</span>.<span style="color:#FF0000">2</span>.<span style="color:#FF0000">1</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">socket</span>.<span style="color:#FF0000">io</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">ServerInterface</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">GameService</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">UserService</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">TicTacToe</span>/<span style="color:#FF0000">Board</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">TicTacToe</span>/<span style="color:#FF0000">Game</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">TicTacToe</span>/<span style="color:#FF0000">ViewModel</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">src</span>=<span style="color:#0000FF">&quot;@Url.Content(&quot;</span>~/<span style="color:#FF0000">Scripts</span>/<span style="color:#FF0000">Game</span>/<span style="color:#FF0000">TicTacToe</span>/<span style="color:#FF0000">Controller</span>.<span style="color:#FF0000">js</span>&quot;)&quot; <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/javascript&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span>
</code></pre></li>
<li><p>Add the following highlighted code at the beginning of the <strong>div</strong> element with Id <strong>game</strong>. This code renders the Invitation URL and the list of players that are in the queue waiting to play.</p>

<!-- mark: 1-32    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">style</span>=<span style="color:#0000FF">&quot;display: none&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: gameQueueId() != null&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span>Player<span style="color:#0000FF">&lt;/</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            Welcome <span style="color:#0000FF">&lt;</span><span style="color:#800000">b</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;text: playerName()&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">b</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: isOwner() &amp;&amp; gameQueueId() != null &amp;&amp; gameId() == null&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span>Use this URL to invite other players: <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;text: inviteURL()&quot;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;/</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">br</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: friends() != null &amp;&amp; friends().length &gt; 0&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            Your Friends</strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">select</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;friends&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;options: friends, optionsValue: &#39;Id&#39;, optionsText: &#39;DisplayName&#39;&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;/</span><span style="color:#800000">select</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                <span style="color:#0000FF">&lt;</span><span style="color:#800000">a</span> <span style="color:#FF0000">href</span>=<span style="color:#0000FF">&quot;#&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;click: inviteFriend&quot;</span><span style="color:#0000FF">&gt;</span>Invite Friend<span style="color:#0000FF">&lt;/</span><span style="color:#800000">a</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">br</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: noPlayers() == 1 &amp;&amp; isOwner()&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span>Waiting for your opponent...<span style="color:#0000FF">&lt;/</span><span style="color:#800000">span</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">style</span>=<span style="color:#0000FF">&quot;display: none&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: gameQueueId() != null&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span>Players<span style="color:#0000FF">&lt;/</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&#39;template: { name: &quot;queueStatus&quot;, foreach: players()}&#39;</span> <span style="color:#0000FF">/&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;queueStatus&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/html&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;</span><span style="color:#800000">b</span><span style="color:#0000FF">&gt;</span>${$data.UserName}<span style="color:#0000FF">&lt;/</span><span style="color:#800000">b</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>Locate the <strong>div</strong> that contains the legend <strong>Game</strong>, and add the following attributes.</p>

<!-- mark: 1    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">style</span>=<span style="color:#0000FF">&quot;display: none&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: gameId() != null&quot;</span><span style="color:#0000FF">&gt;</span></strong>
    <span style="color:#0000FF">&lt;</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span>
        <span style="color:#0000FF">&lt;</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span>Game<span style="color:#0000FF">&lt;/</span><span style="color:#800000">legend</span><span style="color:#0000FF">&gt;</span>
        ...
    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">fieldset</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span>  
</code></pre></li>
<li><p>Replace the <strong>script</strong> block with the following code.</p>

<!-- mark: 2-24    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript">&lt;script type=<span style="color:#8B0000">&quot;text/javascript&quot;</span>&gt;
<strong class="markLine">    <span style="color:#0000FF">var</span> viewModel;</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> gameQueueId = getQueryVariable(<span style="color:#8B0000">&quot;id&quot;</span>);</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> nullGameId = <span style="color:#8B0000">&quot;00000000-0000-0000-0000-000000000000&quot;</span>;</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">function</span> getQueryVariable(variable) {</strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> query = <span style="color:#0000FF">window</span>.<span style="color:#0000FF">location</span>.search.substring(1);</strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> vars = query.split(<span style="color:#8B0000">&quot;&amp;&quot;</span>);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">for</span> (<span style="color:#0000FF">var</span> i = 0; i &lt; vars.<span style="color:#0000FF">length</span>; i++) {</strong>
<strong class="markLine">            <span style="color:#0000FF">var</span> pair = vars[i].split(<span style="color:#8B0000">&quot;=&quot;</span>);</strong>
<strong class="markLine">            <span style="color:#0000FF">if</span> (pair[0] == variable) {</strong>
<strong class="markLine">                <span style="color:#0000FF">return</span> pair[1];</strong>
<strong class="markLine">            }</strong>
<strong class="markLine">        }</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> apiURL = <span style="color:#8B0000">&quot;@this.ViewBag.ApiUrl&quot;</span>;</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> blobURL = <span style="color:#8B0000">&quot;@this.ViewBag.BlobUrl&quot;</span>;</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> nodeJsURL = <span style="color:#8B0000">&quot;@this.ViewBag.NodeJsUrl&quot;</span>;</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> socket = io.connect(nodeJsURL);</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> si = <span style="color:#0000FF">new</span> ServerInterface();</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> gs = <span style="color:#0000FF">new</span> GameService(apiURL, blobURL, si, socket);</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> user = <span style="color:#0000FF">new</span> UserService(apiURL, blobURL, si);</strong>
&lt;/script&gt;
</code></pre>

<p>The previous code instantiates a new Socket pointing to the <strong>Node.JS</strong> server URL. Additionally, the code instantiates the <strong>Game</strong> and <strong>User</strong> services, which interacts with the Web APIs and <strong>Socket.IO</strong>.</p></li>
<li><p>Add the following code at the end of the <strong>script</strong> block.</p>

<!-- mark: 1-21    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine"><span style="color:#0000FF">function</span> start(userId) {</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// check for canvas, show an &quot;Upgrade your browser&quot; screen if they don&#39;t have it.</span></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> canvas = <span style="color:#0000FF">document</span>.getElementById(&#39;board&#39;);</strong>
<strong class="markLine">    <span style="color:#0000FF">if</span> (canvas.getContext == <span style="color:#0000FF">null</span> || canvas.getContext(&#39;2d&#39;) == <span style="color:#0000FF">null</span>) {</strong>
<strong class="markLine">        $(<span style="color:#8B0000">&quot;#game&quot;</span>).toggle();</strong>
<strong class="markLine">        $(<span style="color:#8B0000">&quot;#notSupported&quot;</span>).toggle();</strong>
<strong class="markLine">        <span style="color:#0000FF">return</span>;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> board = <span style="color:#0000FF">new</span> TicTacToeBoard(canvas);</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> game = <span style="color:#0000FF">new</span> TicTacToeGame();</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> controller = <span style="color:#0000FF">new</span> TicTacToeController(viewModel, gs, board, game);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    controller.setGameQueueId(gameQueueId);</strong>
<strong class="markLine">    controller.start();</strong>
<strong class="markLine">    user.getFriendsInfo(<span style="color:#0000FF">function</span> (friends) { viewModel.friends(friends); });</strong>
<strong class="markLine">    user.getUser(userId, <span style="color:#0000FF">function</span> () { });</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">window</span>.onbeforeunload = <span style="color:#0000FF">function</span> () { controller.finish(); };</strong>
<strong class="markLine">}</strong>
</code></pre>

<p>The <strong>start</strong> function initializes the Tic-Tac-Toe board and sets a game queue Id. This Id identifies a game and can be used to invite a Friend to play.</p></li>
<li><p>Add the following code at the end of the <strong>script</strong> block.</p>

<!-- mark: 1-12    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine">$(<span style="color:#0000FF">function</span> () {</strong>
<strong class="markLine">    viewModel = <span style="color:#0000FF">new</span> TicTacToeViewModel();</strong>
<strong class="markLine">    ko.applyBindings(viewModel);</strong>
<strong class="markLine">    user.verify(</strong>
<strong class="markLine">        <span style="color:#0000FF">function</span> (userId) { start(userId); },</strong>
<strong class="markLine">        <span style="color:#0000FF">function</span> () {</strong>
<strong class="markLine">            <span style="color:#0000FF">var</span> newlocation = &#39;@Url.Action(<span style="color:#8B0000">&quot;LogOn&quot;</span>, <span style="color:#8B0000">&quot;Account&quot;</span>, <span style="color:#0000FF">new</span> { Area = <span style="color:#8B0000">&quot;&quot;</span>, ReturnUrl = <span style="color:#8B0000">&quot;replace-in-js&quot;</span> })&#39;;</strong>
<strong class="markLine">            newlocation = newlocation.replace(<span style="color:#8B0000">&quot;replace-in-js&quot;</span>, encodeURIComponent(<span style="color:#0000FF">window</span>.<span style="color:#0000FF">location</span>.href));</strong>
<strong class="markLine">            <span style="color:#0000FF">window</span>.<span style="color:#0000FF">location</span>.assign(newlocation);</strong>
<strong class="markLine">        }</strong>
<strong class="markLine">    );</strong>
<strong class="markLine"> });</strong>
</code></pre></li>
<li><p>Add the following code at the end of the <strong>script</strong> block. This enables to invite other users to play the current game from the view.</p>

<!-- mark: 1-12    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine"><span style="color:#0000FF">function</span> inviteFriend() {</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> userId = $(<span style="color:#8B0000">&quot;#friends&quot;</span>).val();</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> userName = $(<span style="color:#8B0000">&quot;#friends :selected&quot;</span>).text();</strong>
<strong class="markLine">    gs.inviteUser(viewModel.gameQueueId(), userId, <span style="color:#8B0000">&quot;Invitation for Tic Tac Toe&quot;</span>, viewModel.inviteURL(), <span style="color:#0000FF">function</span> () { <span style="color:#0000FF">alert</span>(userName + <span style="color:#8B0000">&quot; was invited&quot;</span>) });</strong>
<strong class="markLine">}</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">function</span> sgusersCallback(user) {</strong>
<strong class="markLine">    <span style="color:#0000FF">if</span> (user.DisplayName != <span style="color:#0000FF">null</span> &amp;&amp; user.DisplayName != <span style="color:#8B0000">&quot;&quot;</span>)</strong>
<strong class="markLine">        viewModel.playerName(user.DisplayName);</strong>
<strong class="markLine">    <span style="color:#0000FF">else</span></strong>
<strong class="markLine">        viewModel.playerName(user.Id);</strong>
<strong class="markLine">}</strong>
</code></pre></li>
</ol>

<p><a name="Ex3Task3"></a> </p>

<h4 id="Task_3_-_Showing_Game_Invitation_Messages_from_Friends">Task 3 - Showing Game Invitation Messages from Friends</h4>

<p>In this task, you will update the Friends view to show the invitation messages from other users.</p>

<ol>
<li><p>Open the <strong>Friends</strong> view located in <strong>Views\Account</strong> folder of the Web project.</p></li>
<li><p>Add the <strong>Invitations</strong> table below the <strong>script</strong> block with id <strong>FriendList</strong>.</p>

<!-- mark: 1-19    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine">&lt;h3&gt;Invitations&lt;/h3&gt;</strong>
<strong class="markLine">&lt;table&gt;</strong>
<strong class="markLine">    &lt;thead&gt;</strong>
<strong class="markLine">        &lt;tr&gt;</strong>
<strong class="markLine">            &lt;th&gt;Message&lt;/th&gt;</strong>
<strong class="markLine">            &lt;th&gt;From&lt;/th&gt;</strong>
<strong class="markLine">            &lt;th&gt;Action&lt;/th&gt;</strong>
<strong class="markLine">        &lt;/tr&gt;</strong>
<strong class="markLine">    &lt;/thead&gt;</strong>
<strong class="markLine">    &lt;tbody data-bind=&#39;template: { <span style="color:#0000FF">name</span>: <span style="color:#8B0000">&quot;NotificationList&quot;</span>, foreach: notifications() }&#39; /&gt;</strong>
<strong class="markLine">&lt;/table&gt;</strong>
<strong class="markLine"></strong>
<strong class="markLine">&lt;script id=<span style="color:#8B0000">&quot;NotificationList&quot;</span> type=<span style="color:#8B0000">&quot;text/html&quot;</span>&gt;</strong>
<strong class="markLine">&lt;tr&gt;</strong>
<strong class="markLine">       &lt;td&gt;${$data.Message} &lt;/td&gt; </strong>
<strong class="markLine">       &lt;td&gt;${$data.SenderName} &lt;/td&gt;</strong>
<strong class="markLine">       &lt;td&gt;&lt;a href=<span style="color:#8B0000">&quot;${$data.Url}&quot;</span>&gt;Go&lt;/a&gt; &lt;/td&gt; </strong>
<strong class="markLine">&lt;/tr&gt;</strong>
<strong class="markLine">&lt;/script&gt;</strong>
</code></pre></li>
<li><p>Add a call to the <strong>user.getNotifications</strong> method in order to retrieve the game invitation messages.</p>

<!-- mark: 9    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript">jQuery(<span style="color:#0000FF">document</span>).ready(<span style="color:#0000FF">function</span> () {
    <span style="color:#0000FF">window</span>.viewModel = <span style="color:#0000FF">new</span> ViewModel();

    ko.applyBindings(<span style="color:#0000FF">window</span>.viewModel);
    user.getFriendsInfo(
        <span style="color:#0000FF">function</span> (friends) { <span style="color:#0000FF">window</span>.viewModel.refreshFriends(friends); },
        <span style="color:#0000FF">function</span> () { <span style="color:#0000FF">alert</span>(&#39;Error Get Friends&#39;); });

<strong class="markLine">    user.getNotifications(userId, <span style="color:#0000FF">function</span> () { });</strong>
});
</code></pre></li>
<li><p>Add a callback method at the end of the block script. This method is used by the <strong>UserService</strong> class to return the invitation messages.</p>

<!-- mark: 1-11    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine"><span style="color:#0000FF">function</span> sgnotificationsCallback(data) {</strong>
<strong class="markLine">    <span style="color:#0000FF">for</span> (<span style="color:#0000FF">var</span> n <span style="color:#0000FF">in</span> data.Notifications) {</strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> notification = data.Notifications[n];</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (notification.SenderName == <span style="color:#0000FF">null</span> || notification.SenderName == <span style="color:#8B0000">&quot;&quot;</span>)</strong>
<strong class="markLine">            notification.SenderName = notification.SenderId;</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">if</span> (notification.Type == <span style="color:#8B0000">&quot;Invite&quot;</span>)</strong>
<strong class="markLine">            viewModel.notifications.push(notification);</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">}</strong>
</code></pre></li>
</ol>

<p><a name="Ex3Verification"></a> </p>

<h4 id="Verification">Verification</h4>
<blockquote>
<p><strong>Note:</strong> Before you execute the solution, make sure that the start-up project and the start-up page are set. </p>

<p>To set the startup project, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web.Azure</strong> project and select <strong>Set as StartUp Project</strong>.</p>

<p>To designate the start page, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web</strong> project and select <strong>Properties</strong>. In the <strong>Properties</strong> window, select the <strong>Web</strong> tab and in the <strong>Start Action</strong>, select <strong>Specific Page</strong>. Set the value of this field empty.</p>
</blockquote>
<ol>
<li><p>Press to <strong>F5</strong> to run the solution.</p></li>
<li><p>Click the <strong>Tic Tac Toe</strong> menu link and log on with an identity provider. You will see the current list of Players that are in the same game queue. Additionally, an invitation URL will be generated. Copy this URL.</p>

<p><img src="images/listing-players-and-the-auto-generated-invita2.png?raw=true" alt="Listing players and the auto generated invitation URL" />
</p>

<p><em>Listing players and the auto generated invitation URL</em></p></li>
<li><p>Open a new <strong>Internet Explorer</strong> session or an <strong>In-Private</strong> by pressing <strong>CTRL+SHIFT+P</strong> without closing the current one.</p></li>
<li><p>Paste the invitation URL. When prompted, enter other credentials to log on. Now, the list of players will show both users. Check the first browser to verify that both users are listed as well.</p>

<p><img src="images/playing-a-multiplayer-tic-tac-toe2.png?raw=true" alt="Playing a multiplayer Tic-Tac-Toe" />
</p>

<p><em>Playing a multiplayer Tic-Tac-Toe</em></p></li>
<li><p>Start playing the game. You will see how the browsers are updated after each move.</p></li>
<li><p>Restart the game by clicking the <strong>Tic Tac Toe</strong> menu link in the first browser. You will see a new drop-down list that shows you friends.</p>

<p><img src="images/listing-friends2.png?raw=true" alt="Listing friends" />
</p>

<p><em>Listing friends</em></p></li>
<li><p>Click the <strong>Invite Friend</strong> link. A confirmation message will appear. Click <strong>OK</strong>.</p>

<p><img src="images/invite-a-friend-confirmation2.png?raw=true" alt="Invite a friend confirmation" />
</p>

<p><em>Invite a friend confirmation</em></p></li>
<li><p>In the second browser, click the <strong>Friends</strong> link. The <strong>Invitations</strong> table will show a new message from the other user. The message has a link that takes you to the Tic Tac Toe page with the game queue Id. Click the <strong>Go</strong> link.</p>

<p><img src="images/invitation-message2.png?raw=true" alt="Invitation Message" />
</p>

<p><em>Invitation Message</em></p></li>
<li><p>The link takes you to the Tic Tac Toe page and a new game will be started.</p></li>
<li><p>Close the browsers.</p></li>
</ol>

<p><a name="Exercise4"></a></p>

<h3 id="Exercise_4_Creating_a_Leaderboard">Exercise 4: Creating a Leaderboard</h3>

<p>In this exercise, you will add the necessary logic to generate a Leaderboard using the User's scores and <strong>Azure Table Storage</strong>. Then you will be able to obtain the top users scores ordered by victories and the amount of defeats and played games of each top user.</p>

<p><a name="Ex4Task1"></a></p>

<h4 id="Task_1_-_Creating_the_Statistics_Repository_Logic">Task 1 - Creating the Statistics Repository Logic</h4>

<p>In this task, you will update the Statistics Repository adding the necessary code to save and retrieve statistics.</p>

<ol>
<li><p>If you completed <strong>Exercise 2</strong> or <strong>Exercise 3</strong> you might continue with the obtained solution, otherwise start <strong>Visual Studio 2010</strong> as Administrator and open <strong>Begin.sln</strong> solution located at <strong>Source\Ex4-CreatingLeaderboard\Begin\[NodeJs|StoragePolling]</strong>. You will see two begin solutions: one is using the Storage Polling approach from Exercise 2 and the other is using Node.Js from Exercise 3, choose the one you prefer for this exercise.</p></li>
<li><p>Open <strong>UserStats</strong> class within <strong>Entities</strong> folder in the <strong>SocialGames.Core</strong> project to check the entity structure used to save the user statistics in the Azure Table Storage.</p>

<!-- mark: 1-10    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">public</span> <span style="color:#0000FF">class</span> UserStats : TableServiceEntity</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    <span style="color:#0000FF">public</span> <span style="color:#0000FF">string</span> UserId { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">public</span> <span style="color:#0000FF">int</span> GameCount { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">public</span> <span style="color:#0000FF">int</span> Victories { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">public</span> <span style="color:#0000FF">int</span> Defeats { <span style="color:#0000FF">get</span>; <span style="color:#0000FF">set</span>; }</strong>
<strong class="markLine">}</strong>
</code></pre></li>
<li><p>Update the <strong>StatisticsRepository</strong> class to implement the necessary code to save and retrieve user statistics. In the <strong>Repositories</strong> folder within <strong>SocialGames.Core</strong> project, open <strong>StatisticsRepository.cs</strong> file.</p></li>
<li><p>Add an <strong>IAzureTable</strong> read only property named <strong>statsTable</strong>. The <strong>AzureTable</strong> class, which implements the <strong>IAzureTable</strong> interface, has the necessary methods to interact with the <strong>Azure Table Storage</strong> (in this case, the <strong>UserStats</strong> table).</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 Adding StatisticsRepository Property - CS</em>)</p>

<!-- mark: 1    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">private</span> <span style="color:#0000FF">readonly</span> IAzureTable&lt;UserStats&gt; statsTable;</strong>
</code></pre></li>
<li><p>Update the <strong>StatisticsRepository</strong> constructor to set the recently added property when the <strong>StatisticsRepository</strong> class is initialized.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 StatisticsRepository Constructor - CS</em>)</p>

<!-- mark: 3-8    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> StatisticsRepository(IAzureTable&lt;UserStats&gt; statsTable)
{
<strong class="markLine">    <span style="color:#0000FF">if</span> (statsTable == <span style="color:#0000FF">null</span>)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">throw</span> <span style="color:#0000FF">new</span> ArgumentNullException(<span style="color:#8B0000">&quot;statsTable&quot;</span>);</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.statsTable = statsTable;</strong>
}
</code></pre></li>
<li><p>Locate <strong>Initialize</strong> method and update it to call the <strong>CreateIfNotExist</strong> method. This method will create the <strong>UserStats</strong> table in case if it does not already exists.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 StatisticsRepository Initialize - CS</em>)</p>

<!-- mark: 3    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> Initialize()
{
<strong class="markLine">    <span style="color:#0000FF">this</span>.statsTable.CreateIfNotExist();</strong>
}
</code></pre></li>
<li><p>Update the <strong>Save</strong> method by replacing its content with the following highlighted code.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 StatisticsRepository Save - CS</em>)</p>

<!-- mark: 3-10    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">void</span> Save(UserStats stats)
{
<strong class="markLine">    stats.RowKey = EncodeKey(stats.UserId);</strong>
<strong class="markLine">    UserStats currentStat = <span style="color:#0000FF">this</span>.statsTable.Query.Where(item =&gt; item.RowKey == stats.RowKey).FirstOrDefault();</strong>
<strong class="markLine">    <span style="color:#0000FF">if</span> (currentStat != <span style="color:#0000FF">null</span>)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.statsTable.DeleteEntity(currentStat);</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.statsTable.AddEntity(stats);</strong>
}
</code></pre></li>
<li><p>Locate the <strong>Retrieve</strong> method and add the necessary code to retrieve the scores for a specific user.</p>

<p>(Code Snippet - Building a Social Game - Ex4 StatisticsRepository Retrieve - CS)</p>

<!-- mark: 3    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> UserStats Retrieve(<span style="color:#0000FF">string</span> userId)
{
<strong class="markLine">    <span style="color:#0000FF">return</span> <span style="color:#0000FF">this</span>.statsTable.Query.Where(item =&gt; item.RowKey.Equals(EncodeKey(userId))).FirstOrDefault();</strong>
}
</code></pre></li>
<li><p>Finally, update <strong>GenerateLeaderboard</strong> method. This method returns a <strong>Board</strong> object that contains the board name and an array of Users' Scores.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 StatisticsRepository GenerateLeaderboard - CS</em>)</p>

<!-- mark: 3-26    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> Board GenerateLeaderboard(<span style="color:#0000FF">int</span> focusCount)
{
<strong class="markLine">    <span style="color:#0000FF">int</span> id = 0;</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> board = <span style="color:#0000FF">new</span> Board()</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        Id = ++id,</strong>
<strong class="markLine">        Name = <span style="color:#8B0000">&quot;Victories&quot;</span>,</strong>
<strong class="markLine">        Scores = <span style="color:#0000FF">null</span></strong>
<strong class="markLine">    };</strong>
<strong class="markLine"></strong>
<strong class="markLine">    UserStats[] data = <span style="color:#0000FF">this</span>.statsTable.Query.Take(focusCount).ToArray();</strong>
<strong class="markLine">    board.Scores = <span style="color:#0000FF">new</span> Score[data.Count()];</strong>
<strong class="markLine">    <span style="color:#0000FF">int</span> a = 0;</strong>
<strong class="markLine">    <span style="color:#0000FF">foreach</span> (UserStats stats <span style="color:#0000FF">in</span> data)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        board.Scores[a] = <span style="color:#0000FF">new</span> Score()</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            Id = ++a,</strong>
<strong class="markLine">            UserId = stats.UserId,</strong>
<strong class="markLine">            Victories = stats.Victories,</strong>
<strong class="markLine">            Defeats = stats.Defeats,</strong>
<strong class="markLine">            GameCount = stats.GameCount</strong>
<strong class="markLine">        };</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">return</span> board;</strong>
}
</code></pre></li>
<li><p>Save changes in <strong>StatisticsRepository.cs</strong>.</p>
<blockquote>
<p><strong>Note:</strong> The StatisticsRepository class has two static methods: <em>EncodeKey</em> and <em>DecodeKey</em>. You will use these methods to encode/decode the UserId when assigning it as RowKey and for querying the Azure Table filtering by RowKey. </p>

<p>This is because RowKey and PartitionKey values do not support some characters that might be included in the claims that the ACS providers return. For more information, go to <a href="http://msdn.microsoft.com/en-us/library/windowsazure/dd179338.aspx"><a href="http://msdn.microsoft.com/en-us/library/windowsazure/dd179338.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/dd179338.aspx</a></a>.</p>
</blockquote></li>
</ol>

<p><a name="Ex4Task2"></a></p>

<h4 id="Task_2_-_Adding_Statistics_Entries">Task 2 - Adding Statistics Entries</h4>

<p>In this task, you will update the Worker Role to save each game's statistics in Azure Table Storage.</p>

<ol>
<li><p>In the <strong>Solution Explorer</strong>, locate the <strong>SocialGames.Worker</strong> project and expand the <strong>Commands</strong> folder.</p></li>
<li><p>Add <strong>GameActionCommand</strong> and <strong>GameActionStatisticsCommand</strong> classes from <strong>Assets\Commands</strong> folder.</p></li>
<li><p>Open the <strong>WorkerRole.cs</strong> class within <strong>SocialGames.Worker</strong> project.</p></li>
<li><p>Update <strong>Run</strong> method adding the following code immediately below the task builder callback for logging errors declaration.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 WorkerRole Run - CS</em>)</p>

<!-- mark: 10-19    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">void</span> Run()
{
...
    <span style="color:#008000">// TaskBuilder callback for logging errors</span>
    Action&lt;ICommand, IDictionary&lt;<span style="color:#0000FF">string</span>, <span style="color:#0000FF">object</span>&gt;, Exception&gt; logException = (cmd, context, ex) =&gt;
    {
        Trace.TraceError(ex.ToString());
    };

<strong class="markLine">    <span style="color:#008000">// Game Action for Statistics messages</span></strong>
<strong class="markLine">    Task.TriggeredBy(Message.OfType&lt;GameActionStatisticsMessage&gt;(account, ConfigurationConstants.GameActionStatisticsQueue))</strong>
<strong class="markLine">        .SetupContext((message, context) =&gt;</strong>
<strong class="markLine">        {</strong>
<strong class="markLine">            context.Add(<span style="color:#8B0000">&quot;gameAction&quot;</span>, message.GameAction);</strong>
<strong class="markLine">        })</strong>
<strong class="markLine">        .Do(container.Resolve&lt;GameActionStatisticsCommand&gt;())</strong>
<strong class="markLine">        .OnError(logException)</strong>
<strong class="markLine">        .Start();</strong>
<strong class="markLine"></strong>
...
}
</code></pre>

<p>In this code, you are registering the command in the job engine, which will execute these instructions asynchronously.</p></li>
<li><p>Register the new types in a Dependency Injection container using <strong>Autofac</strong>. To do this, add the following code at the end of <strong>DependencySetup</strong> method.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 WorkerRole DependencySetup - CS</em>)</p>

<!-- mark: 1-3    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine">builder.RegisterType&lt;StatisticsRepository&gt;().AsImplementedInterfaces();</strong>
<strong class="markLine">builder.RegisterType&lt;GameActionCommand&gt;();</strong>
<strong class="markLine">builder.RegisterType&lt;GameActionStatisticsCommand&gt;();</strong>
</code></pre></li>
<li><p>Open the <strong>GameActionStatisticsCommand</strong> class. Locate the <strong>Do</strong> method and implement the following code to generate and save the statistics. The application will call this method each time a Tic-Tac-Toe game finishes.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 GameActionStatisticsCommand Do - CS</em>)</p>

<!-- mark: 3-17    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> <span style="color:#0000FF">override</span> <span style="color:#0000FF">void</span> Do(GameAction gameAction)
{
<strong class="markLine">    <span style="color:#0000FF">if</span> (<span style="color:#0000FF">string</span>.IsNullOrWhiteSpace(gameAction.UserId))</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">return</span>;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Retrieve existent statistics and update them with the new results</span></strong>
<strong class="markLine">    UserStats currentStatistics = <span style="color:#0000FF">this</span>.statisticsRepository.Retrieve(gameAction.UserId);</strong>
<strong class="markLine">    currentStatistics = UpdateCurrentStats(gameAction, currentStatistics);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#008000">// Generate a new UserStats with the updated RowKey to add in the TableStorage</span></strong>
<strong class="markLine">    UserStats statistics = <span style="color:#0000FF">null</span>;</strong>
<strong class="markLine">    statistics = CreateUpdatedStats(currentStatistics);</strong>
<strong class="markLine">    statistics.PartitionKey = (<span style="color:#0000FF">int</span>.MaxValue - statistics.Victories).ToString().PadLeft(<span style="color:#0000FF">int</span>.MaxValue.ToString().Length);</strong>
<strong class="markLine">    statistics.RowKey = statistics.UserId;</strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.statisticsRepository.Save(statistics);</strong>
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> This solution takes advantage of how Table Storage sorts entities to ensure the top players appear first on the table; that way, retrieving the top(N) entities from the table will return the first N players in the leaderboard sorted correctly (the one with the most victories first.)</p>

<p>In Table Storage the Partition and Row Keys are strings, and records are sorted ascendant using first the Partition Key and then the Row Key. Taking this into account, if all the keys have the same amount of characters, and the top player has the smallest PartitionKey (using string comparison) it will appear first in the table.</p>

<p>To achieve this, the solution generates the partition key using the following formula: PartitionKey = int.maxValue - UserVictories, and ensures all the keys have the same length by prepending &quot;0&quot; to the resulting number. This guarantees that the first records correspond to those players with the most victories.</p>

<p>The downside of using this approach is that, in order to update the player's score, the record needs to be deleted and added again using the new Partition Key; otherwise the table will not be sorted correctly.</p>
</blockquote></li>
<li><p>Add the <strong>UpdateCurrentStats</strong> method that updates the current User's statistics with the latest game's scores.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 GameActionStatisticsCommand UpdateCurrentStats - CS</em>)</p>

<!-- mark: 1-13    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> UserStats UpdateCurrentStats(GameAction gameAction, UserStats originalStatistics)</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    <span style="color:#0000FF">if</span> (originalStatistics == <span style="color:#0000FF">null</span>)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        originalStatistics = <span style="color:#0000FF">new</span> UserStats();</strong>
<strong class="markLine">        originalStatistics.UserId = gameAction.UserId;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    originalStatistics.Victories += GetValue(gameAction.CommandData, <span style="color:#8B0000">&quot;Victories&quot;</span>);</strong>
<strong class="markLine">    originalStatistics.Defeats += GetValue(gameAction.CommandData, <span style="color:#8B0000">&quot;Defeats&quot;</span>);</strong>
<strong class="markLine">    originalStatistics.GameCount += GetValue(gameAction.CommandData, <span style="color:#8B0000">&quot;GameCount&quot;</span>);</strong>
<strong class="markLine">    <span style="color:#0000FF">return</span> originalStatistics;</strong>
<strong class="markLine">}</strong>
</code></pre></li>
<li><p>Add the <strong>CreateUpdatedStats</strong> method. This method generates a new <strong>UserStats</strong> object with the updated user's scores.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 GameActionStatisticsCommand CreateUpdatedStats - CS</em>)</p>

<!-- mark: 1-11    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine"><span style="color:#0000FF">private</span> <span style="color:#0000FF">static</span> UserStats CreateUpdatedStats(UserStats originalStatistics)</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> statistics = <span style="color:#0000FF">new</span> UserStats</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        UserId = originalStatistics.UserId,</strong>
<strong class="markLine">        Victories = originalStatistics.Victories,</strong>
<strong class="markLine">        Defeats = originalStatistics.Defeats,</strong>
<strong class="markLine">        GameCount = originalStatistics.GameCount</strong>
<strong class="markLine">    };</strong>
<strong class="markLine">    <span style="color:#0000FF">return</span> statistics;</strong>
<strong class="markLine">}</strong>
</code></pre></li>
</ol>

<p><a name="Ex4Task3"></a></p>

<h4 id="Task_3_-_Creating_a_Leaderboard">Task 3 - Creating a Leaderboard</h4>

<p>In this task, you will update the Web project to implement all the functionality added in the previous tasks to generate the leaderboard.</p>

<ol>
<li><p>In the <strong>Solution Explorer</strong>, locate the <strong>TicTacToe.Web</strong> project and expand the <strong>Views\Account</strong> folder. Add a new view named <strong>Leaderboard.cshtml</strong>.</p></li>
<li><p>Replace the <strong>Leaderboard.cshtml</strong> content with the following code.</p>

<!-- mark: 1-50    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><strong class="markLine">@{</strong>
<strong class="markLine">    ViewBag.Title = &quot;TicTacToe Leaderboard&quot;;</strong>
<strong class="markLine">}</strong>
<strong class="markLine"></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">h2</span><span style="color:#0000FF">&gt;</span>Leaderboard<span style="color:#0000FF">&lt;/</span><span style="color:#800000">h2</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">p</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        The leaderboard shows the scores of the Tic Tac Toe game sample.<span style="color:#0000FF">&lt;/</span><span style="color:#800000">p</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">p</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;status&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        Loading...</strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">p</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: isScoresEmpty()&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        There are no scores yet. Start playing to gather the leaderboard records.<span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">div</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;visible: !isScoresEmpty(), template: { name: &#39;board&#39;, foreach: topScores}&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span> </strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;board&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/html&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">table</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1 board&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&#39;attr: { id: &quot;board&quot; + Id }&#39;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">thead</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                <span style="color:#0000FF">&lt;</span><span style="color:#800000">tr</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;</span><span style="color:#800000">th</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                        Position</strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">th</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;</span><span style="color:#800000">th</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                        Player</strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">th</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;</span><span style="color:#800000">th</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&#39;css: { highlight: Name == &quot;Victories&quot; }&#39;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                        Victories</strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">th</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;</span><span style="color:#800000">th</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&#39;css: { highlight: Name == &quot;Defeats&quot; }&#39;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                        Defeats</strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">th</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;</span><span style="color:#800000">th</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&#39;css: { highlight: Name == &quot;GameCount&quot; }&#39;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                        Game Count</strong>
<strong class="markLine">                    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">th</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">                <span style="color:#0000FF">&lt;/</span><span style="color:#800000">tr</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;/</span><span style="color:#800000">thead</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">tbody</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&#39;template: { name: &quot;score&quot;, foreach: Scores }&#39;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;/</span><span style="color:#800000">tbody</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">table</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;</span><span style="color:#800000">script</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;score&quot;</span> <span style="color:#FF0000">type</span>=<span style="color:#0000FF">&quot;text/html&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">tr</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;css: { d1: Id % 2 == 0, d1: Id % 2 == 1 }&quot;</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">td</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;css: { highlight: window.viewModel.currentUserId == UserId }, text: Id&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">td</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">td</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;left-aligned&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;css: { highlight: window.viewModel.currentUserId == UserId }, text: UserName&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">td</span><span style="color:#0000FF">&gt;</span>  </strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">td</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;css: { highlight: window.viewModel.currentUserId == UserId }, text: Victories&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">td</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">td</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;css: { highlight: window.viewModel.currentUserId == UserId }, text: Defeats&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">td</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">            <span style="color:#0000FF">&lt;</span><span style="color:#800000">td</span> <span style="color:#FF0000">class</span>=<span style="color:#0000FF">&quot;style1&quot;</span> <span style="color:#FF0000">data</span>-<span style="color:#FF0000">bind</span>=<span style="color:#0000FF">&quot;css: { highlight: window.viewModel.currentUserId == UserId }, text: GameCount&quot;</span><span style="color:#0000FF">&gt;</span><span style="color:#0000FF">&lt;/</span><span style="color:#800000">td</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">        <span style="color:#0000FF">&lt;/</span><span style="color:#800000">tr</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine">    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">script</span><span style="color:#0000FF">&gt;</span></strong>
<strong class="markLine"><span style="color:#0000FF">&lt;/</span><span style="color:#800000">div</span><span style="color:#0000FF">&gt;</span></strong>
</code></pre></li>
<li><p>Add the following script highlighted references at the top of the view. The <strong>UserService.js</strong> library is used to communicate with the Server API UserService and retrieve the top scores for the leaderboard.</p>

<!-- mark: 5-8    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript">@{
    ViewBag.Title = <span style="color:#8B0000">&quot;TicTacToe Leaderboard&quot;</span>;
}

<strong class="markLine">&lt;script src=<span style="color:#8B0000">&quot;@Url.Content(&quot;</span>~/Scripts/jquery.tmpl.js<span style="color:#8B0000">&quot;)&quot;</span> type=<span style="color:#8B0000">&quot;text/javascript&quot;</span>&gt;&lt;/script&gt;</strong>
<strong class="markLine">&lt;script src=<span style="color:#8B0000">&quot;@Url.Content(&quot;</span>~/Scripts/knockout-1.2.1.js<span style="color:#8B0000">&quot;)&quot;</span> type=<span style="color:#8B0000">&quot;text/javascript&quot;</span>&gt;&lt;/script&gt;</strong>
<strong class="markLine">&lt;script src=<span style="color:#8B0000">&quot;@Url.Content(&quot;</span>~/Scripts/Game/ServerInterface.js<span style="color:#8B0000">&quot;)&quot;</span> type=<span style="color:#8B0000">&quot;text/javascript&quot;</span>&gt;&lt;/script&gt;</strong>
<strong class="markLine">&lt;script src=<span style="color:#8B0000">&quot;@Url.Content(&quot;</span>~/Scripts/Game/UserService.js<span style="color:#8B0000">&quot;)&quot;</span> type=<span style="color:#8B0000">&quot;text/javascript&quot;</span>&gt;&lt;/script&gt;</strong>

&lt;h2&gt;Leaderboard&lt;/h2&gt;
</code></pre></li>
<li><p>Finally, add the following JavaScript code block to bind the view with the View Model.</p>

<!-- mark: 1-31    -->

<span class="codelanguage">JavaScript</span><pre><code class="JavaScript"><strong class="markLine">&lt;script type=<span style="color:#8B0000">&quot;text/javascript&quot;</span>&gt;</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> apiURL = <span style="color:#8B0000">&quot;@this.ViewBag.ApiUrl&quot;</span>;</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> blobURL = <span style="color:#8B0000">&quot;@this.ViewBag.BlobUrl&quot;</span>;</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> si = <span style="color:#0000FF">new</span> ServerInterface();</strong>
<strong class="markLine">    <span style="color:#0000FF">var</span> user = <span style="color:#0000FF">new</span> UserService(apiURL, blobURL, si);</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">function</span> ViewModel() {</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.isScoresEmpty = ko.observable(<span style="color:#0000FF">false</span>);</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.currentUserId = <span style="color:#8B0000">&quot;@this.ViewBag.CurrentUserId&quot;</span>;</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.topScores = ko.observableArray();</strong>
<strong class="markLine">    }</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">window</span>.topScoresCallback = <span style="color:#0000FF">function</span> (items) {</strong>
<strong class="markLine">        <span style="color:#0000FF">window</span>.viewModel.topScores(items);</strong>
<strong class="markLine">        <span style="color:#0000FF">window</span>.viewModel.isScoresEmpty(<span style="color:#0000FF">window</span>.viewModel.topScores().Scores.<span style="color:#0000FF">length</span> == 0);</strong>
<strong class="markLine">        $(<span style="color:#8B0000">&quot;.status&quot;</span>).hide();</strong>
<strong class="markLine">    };</strong>
<strong class="markLine"></strong>
<strong class="markLine">    $(<span style="color:#0000FF">function</span> () {</strong>
<strong class="markLine">        <span style="color:#0000FF">window</span>.viewModel = <span style="color:#0000FF">new</span> ViewModel();</strong>
<strong class="markLine"></strong>
<strong class="markLine">        user.getLeaderboard(10, topScoresCallback, errorCallback);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        ko.applyBindings(viewModel);</strong>
<strong class="markLine">    });</strong>
<strong class="markLine"></strong>
<strong class="markLine">    <span style="color:#0000FF">function</span> errorCallback(er) {</strong>
<strong class="markLine">        <span style="color:#0000FF">alert</span>(<span style="color:#8B0000">&quot;The leaderboard is not available right now, please try later.&quot;</span>);</strong>
<strong class="markLine">    }        </strong>
<strong class="markLine">&lt;/script&gt;</strong>
</code></pre></li>
<li><p>Open <strong>AccountController.cs</strong> file from <strong>Controllers</strong> folder and add the <strong>Leaderboard</strong> action method.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 AccountController Leaderboard - CS</em>)</p>

<!-- mark: 1-6    -->

<span class="codelanguage">C#</span><pre><code class="C#"><strong class="markLine">[Authorize]</strong>
<strong class="markLine"><span style="color:#0000FF">public</span> ActionResult Leaderboard()</strong>
<strong class="markLine">{</strong>
<strong class="markLine">    <span style="color:#0000FF">this</span>.ViewBag.CurrentUserId = <span style="color:#0000FF">this</span>.userProvider.UserId;</strong>
<strong class="markLine">    <span style="color:#0000FF">return</span> View();</strong>
<strong class="markLine">}</strong>
</code></pre></li>
<li><p>Open the <strong>UserService.cs</strong> class from <strong>Services</strong> folder and update the <strong>Leaderboard</strong> method to return the statistics board's.</p>

<p>(Code Snippet - <em>Building a Social Game - Ex4 UserService Leaderboard - CS</em>)</p>

<!-- mark: 3-13    -->

<span class="codelanguage">C#</span><pre><code class="C#"><span style="color:#0000FF">public</span> Board Leaderboard(<span style="color:#0000FF">int</span> count)
{
<strong class="markLine">    <span style="color:#0000FF">try</span></strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">var</span> board = <span style="color:#0000FF">this</span>.statsRepository.GenerateLeaderboard(count);</strong>
<strong class="markLine">        <span style="color:#0000FF">this</span>.UpdateUserName(<span style="color:#0000FF">ref</span> board);</strong>
<strong class="markLine"></strong>
<strong class="markLine">        <span style="color:#0000FF">return</span> board;</strong>
<strong class="markLine">    }</strong>
<strong class="markLine">    <span style="color:#0000FF">catch</span> (Exception ex)</strong>
<strong class="markLine">    {</strong>
<strong class="markLine">        <span style="color:#0000FF">throw</span> <span style="color:#0000FF">new</span> ServiceException(<span style="color:#8B0000">&quot;Could not retrieve statistics from the database. &quot;</span> + ex.Message);</strong>
<strong class="markLine">    }</strong>
}
</code></pre></li>
<li><p>Finally, add a new menu item in the <strong>_Layout.cshtml</strong> view within <strong>Views\Shared</strong> folder.</p>

<!-- mark: 6    -->

<span class="codelanguage">CSHTML</span><pre><code class="CSHTML"><span style="color:#0000FF">&lt;</span><span style="color:#800000">nav</span><span style="color:#0000FF">&gt;</span>
    <span style="color:#0000FF">&lt;</span><span style="color:#800000">ul</span> <span style="color:#FF0000">id</span>=<span style="color:#0000FF">&quot;menu&quot;</span><span style="color:#0000FF">&gt;</span>
        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>@Html.ActionLink(&quot;Home&quot;, &quot;Index&quot;, &quot;Home&quot;, new { area = &quot;&quot; }, null)<span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>
        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>@Html.ActionLink(&quot;Tic Tac Toe&quot;, &quot;Index&quot;, &quot;TicTacToe&quot;, new { area = &quot;&quot; }, null)<span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>
        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>@Html.ActionLink(&quot;Friends&quot;, &quot;Friends&quot;, &quot;Account&quot;, new { area = &quot;&quot; }, null)<span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>
<strong class="markLine">        <span style="color:#0000FF">&lt;</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span>@Html.ActionLink(&quot;Leaderboard&quot;, &quot;Leaderboard&quot;, &quot;Account&quot;, new { area = &quot;&quot; }, null)<span style="color:#0000FF">&lt;/</span><span style="color:#800000">li</span><span style="color:#0000FF">&gt;</span></strong>
    <span style="color:#0000FF">&lt;/</span><span style="color:#800000">ul</span><span style="color:#0000FF">&gt;</span>
<span style="color:#0000FF">&lt;/</span><span style="color:#800000">nav</span><span style="color:#0000FF">&gt;</span>
</code></pre></li>
<li><p>Save all the changes.</p></li>
</ol>

<p><a name="Ex4Verification"></a></p>

<h4 id="Verification">Verification</h4>
<blockquote>
<p><strong>Note:</strong> Before you execute the solution, make sure that the start-up project and the start-up page are set. </p>

<p>To set the startup project, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web.Azure</strong> project and select <strong>Set as StartUp Project</strong>.</p>

<p>To designate the start page, in <strong>Solution Explorer</strong>, right-click the <strong>TicTacToe.Web</strong> project and select <strong>Properties</strong>. In the <strong>Properties</strong> window, select the <strong>Web</strong> tab and in the <strong>Start Action</strong>, select <strong>Specific Page</strong>. Set the value of this field empty.</p>
</blockquote>
<ol>
<li><p>Press to <strong>F5</strong> to run the solution.</p></li>
<li><p>Click <strong>Leaderboard</strong> in the menu and log in with your Microsoft Account or Facebook account. If this is the first time you run this verification, the leaderboard page should show a <em>There are no scores yet</em> message. You will populate this table by playing some Tic-Tac-Toe games in the following steps.</p>

<p><img src="images/empty-leaderboard.png?raw=true" alt="Empty Leaderboard" />
</p>

<p><em>Empty Leaderboard</em></p></li>
<li><p>To start generating Scores, click <strong>Tic Tac Toe</strong> in the menu and play a Tic-Tac-Toe game.</p>

<p><img src="images/generating-statistics-playing-tic-tac-toe.png?raw=true" alt="Generating Statistics playing Tic Tac Toe" />
</p>

<p><em>Generating Statistics playing Tic Tac Toe</em></p>
<blockquote>
<p><strong>Note:</strong> You will need to open a second browser and join the Tic-Tac-Toe game using another user account and the invite URL provided in order to generate the game's statistics. Once you finish the game, it will save the scores in the UserStats Azure Table Storage.</p>
</blockquote></li>
<li><p>Go back to the <strong>Leaderboard</strong> section and verify that the Leaderboard table shows two entries one for each user and the scores they have.</p>

<p><img src="images/top-scores-leaderboard.png?raw=true" alt="Top Scores Leaderboard" />
</p>

<p><em>Top Scores Leaderboard</em></p></li>
<li><p>Repeat the <strong>Step 3</strong> using different accounts and verify the updated Leaderboard table.</p></li>
</ol>

<hr />

<p><a name="Summary"></a></p>

<h2 id="Summary">Summary</h2>

<p>In this hands-on lab, you have seen how to take advantage of the <strong>Windows Azure</strong> services benefits when building a Social Game.
You have seen how to add <strong>Access Control</strong> service support to an existing application, to allow your users authenticate using multiple Social Providers, such as <strong>Microsoft Account</strong> or <strong>Facebook</strong>.
You have also seen how to enable Multi-Player using <strong>Storage Polling</strong> and <strong>Node.JS</strong> to emit and broadcast the players game moves to other clients in real time.
Finally, you have seen how to create a leaderboard using <strong>Azure Table Storage</strong>.</p>

</span>
		</div>
	<br />
	<p><a href="#top">top of page</a></p>


				</div>
			</section>
			<footer>
				<div class="footer-sitemap" style="border-top:0"></div>
				<div class="footer-bottom">
					<ul>
						<li class="footer-copyright"><a href="http://www.microsoft.com"><img alt="microsoft" src="images/microsoft.png" /></a></li>					
												<li><a href="https://github.com/WindowsAzure-TrainingKit/HOL-BuildingSocialGame/issues" target="_new">File an Issue</a></li>
												<li><a href="mailto:azcfeed@microsoft.com?subject=Windows Azure Training Kit">Contact Us</a></li>						
						<li><a href=".\">Browse Content</a></li>
						<li>&copy; 2012 Microsoft</li>
					</ul>
				</div>
			</footer>
			</div>
        </div>
    </div>
</body>
</html>

